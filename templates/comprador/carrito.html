<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Carrito - AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
</head>
<body>
    <!-- ====== MEN√ö SUPERIOR ====== -->
    <nav>
        <div class="nav-left">
            <div class="logo">
                <h2>AgroMarket</h2>
            </div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="{{ url_for('comprador.panel_comprador') }}">Inicio</a>
            <a href="{{ url_for('comprador.ver_productos') }}">Productos</a>
            <a href="{{ url_for('comprador.ver_carrito') }}" class="activo">Carrito</a>
            <a href="{{ url_for('auth.perfil') }}">Mi Perfil</a>
            <a href="{{ url_for('auth.logout') }}">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <!-- ====== CONTENIDO PRINCIPAL ====== -->
    <main class="carrito-main">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
              {% for category, message in messages %}
                <div class="flash-message {{ category }}">
                  {% if category == 'success' %}
                    <i class="fas fa-check-circle"></i>
                  {% elif category == 'danger' %}
                    <i class="fas fa-exclamation-circle"></i>
                  {% elif category == 'warning' %}
                    <i class="fas fa-exclamation-triangle"></i>
                  {% elif category == 'info' %}
                    <i class="fas fa-info-circle"></i>
                  {% endif %}
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% if carrito %}
            <!-- ===== COLUMNA IZQUIERDA: LISTA DE PRODUCTOS ===== -->
            <section class="carrito-productos">
                <header class="carrito-header">
                    <h1>Carrito</h1>
                    <p>Revisa tus art√≠culos antes de pagar</p>
                </header>

                <div class="productos-lista">
                    {% for item in carrito %}
                    <div class="producto-carrito-item">
                        <div class="producto-imagen">
                            <img src="{{ url_for('static', filename='uploads/' + item.imagen) if item.imagen else url_for('static', filename='images/default-product.png') }}" alt="{{ item.nombre }}" loading="lazy">
                        </div>
                        <div class="producto-info">
                            <h3>{{ item.nombre }}</h3>
                            <div class="producto-details">
                                <span class="producto-origin">{{ item.origen if item.origen else 'Local' }} ‚Ä¢ {{ item.unidad if item.unidad else 'kg' }}</span>
                            </div>
                            <div class="producto-cantidad">
                                <div class="cantidad-controls">
                                    <form action="{{ url_for('comprador.disminuir_cantidad', producto_id=item.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-cantidad-carrito disminuir" title="Disminuir cantidad">-</button>
                                    </form>
                                    <span class="cantidad-display">{{ item.cantidad }} {{ item.unidad if item.unidad else 'kg' }}</span>
                                    <form action="{{ url_for('comprador.aumentar_cantidad', producto_id=item.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-cantidad-carrito aumentar" title="Aumentar cantidad">+</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="producto-precio">
                            <span>${{ "%.2f"|format((item.precio|float * item.cantidad)) }}</span>
                        </div>
                        <div class="producto-acciones">
                                <form action="{{ url_for('comprador.eliminar_del_carrito', producto_id=item.id) }}" method="POST">
                                <button type="submit" class="btn-eliminar" title="Eliminar del carrito">üóëÔ∏è</button>
                                </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="carrito-nota">
                    <p>Nota: Las cantidades y precios son referenciales.</p>
                </div>

                <!-- Secci√≥n de direcci√≥n de env√≠o -->
                <div class="direccion-envio-section accordion-section">
                    <div class="accordion-header" onclick="toggleAccordion('direccion-content')">
                        <div class="accordion-title">
                            <h3>Direcci√≥n de env√≠o</h3>
                            <p class="direccion-subtitle">¬øD√≥nde quieres recibir tu pedido?</p>
                        </div>
                        <span class="accordion-icon" id="direccion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="direccion-content" style="display: none;">
                        <div class="form-group">
                            <label for="direccion">Direcci√≥n completa</label>
                            <input type="text" id="direccion" name="direccion" placeholder="Ingresa tu direcci√≥n completa" required>
                        </div>
                    </div>
                </div>

                <!-- Formulario de m√©todo de pago -->
                <div class="metodo-pago-section accordion-section">
                    <div class="accordion-header" onclick="toggleAccordion('pago-content')">
                        <div class="accordion-title">
                            <h3>M√©todo de pago</h3>
                            <p class="metodo-pago-subtitle">Selecciona tu m√©todo de pago</p>
                        </div>
                        <span class="accordion-icon" id="pago-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="pago-content" style="display: none;">
                        <div class="metodo-pago-options">
                        <div class="metodo-option" data-value="efectivo">
                            <input type="radio" id="metodo_efectivo" name="metodo_pago" value="efectivo">
                            <label for="metodo_efectivo">
                                <span class="metodo-icon">üíµ</span>
                                <div class="metodo-info">
                                    <span class="metodo-title">Efectivo contra entrega</span>
                                    <span class="metodo-desc">Paga cuando recibas tu pedido</span>
                                </div>
                            </label>
                        </div>

                        <div class="metodo-option" data-value="transferencia">
                            <input type="radio" id="metodo_transferencia" name="metodo_pago" value="transferencia">
                            <label for="metodo_transferencia">
                                <span class="metodo-icon">üè¶</span>
                                <div class="metodo-info">
                                    <span class="metodo-title">Transferencia bancaria</span>
                                    <span class="metodo-desc">Transferencia directa a nuestra cuenta</span>
                                </div>
                            </label>
                        </div>

                        <div class="metodo-option" data-value="tarjeta">
                            <input type="radio" id="metodo_tarjeta" name="metodo_pago" value="tarjeta">
                            <label for="metodo_tarjeta">
                                <span class="metodo-icon">üí≥</span>
                                <div class="metodo-info">
                                    <span class="metodo-title">Tarjeta de d√©bito/cr√©dito</span>
                                    <span class="metodo-desc">Pago seguro con tarjeta</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Mensaje para efectivo -->
                    <div id="efectivo-mensaje" class="metodo-mensaje" style="display: none;">
                        <div class="mensaje-info">
                            <span class="mensaje-icon">üí°</span>
                            <div class="mensaje-content">
                                <h4>Informaci√≥n importante</h4>
                                <p>Al seleccionar pago en efectivo, deber√°s pagar el monto total cuando recibas tu pedido. El repartidor llevar√° el cambio exacto.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Campos adicionales para tarjeta -->
                    <div id="tarjeta-campos" class="tarjeta-campos" style="display: none;">
                        <div class="form-group">
                            <label for="nombre_titular">Nombre del titular</label>
                            <input type="text" id="nombre_titular" name="nombre_titular" placeholder="Nombre completo del titular" maxlength="100">
                        </div>

                        <div class="form-group">
                            <label for="numero_tarjeta">N√∫mero de tarjeta</label>
                            <input type="text" id="numero_tarjeta" name="numero_tarjeta" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha_vencimiento">Fecha de vencimiento</label>
                                <input type="text" id="fecha_vencimiento" name="fecha_vencimiento" placeholder="MM/AA" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enviar_comprobante" name="enviar_comprobante" value="1">
                                Enviar comprobante al correo electr√≥nico
                            </label>
                        </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ===== COLUMNA DERECHA: RESUMEN Y CHECKOUT ===== -->
            <aside class="carrito-checkout">
                <div class="checkout-summary">
                    <h3>Resumen del pedido</h3>
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span>${{ "%.2f"|format(total) }}</span>
                    </div>
                    <div class="summary-line">
                        <span>Env√≠o estimado</span>
                        <span>$4.50</span>
                    </div>
                    <div class="summary-line">
                        <span>Impuestos</span>
                        <span>${{ "%.2f"|format(total * 0.1) }}</span>
                    </div>
                    <div class="summary-line total">
                        <span>Total</span>
                        <span>${{ "%.2f"|format(total * 1.1 + 4.50) }}</span>
                    </div>
                </div>

                <form action="{{ url_for('comprador.finalizar_compra') }}" method="POST" class="checkout-form">
                    <div class="form-group">
                        <label for="nota">Nota para el vendedor</label>
                        <textarea id="nota" name="nota" placeholder="Agrega una nota para el vendedor..." rows="3"></textarea>
            </div>

                    <button type="submit" class="btn-proceder-pago">Proceder al pago</button>
            </form>
            </aside>
        {% else %}
            <!-- ===== CARRITO VAC√çO ===== -->
            <div class="carrito-vacio">
                <div class="carrito-vacio-content">
                    <h1>Tu carrito est√° vac√≠o</h1>
                    <p>Agrega algunos productos deliciosos para comenzar tu compra</p>
                    <a href="{{ url_for('comprador.ver_productos') }}" class="btn-comenzar-compras">Comenzar a comprar</a>
                </div>
            </div>
        {% endif %}
    </main>

    <!-- ===== JavaScript ===== -->
    <script>
        // Funci√≥n para toggle del acorde√≥n
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(contentId.replace('-content', '-icon'));
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Manejo de formulario de pago
        document.addEventListener('DOMContentLoaded', function() {
            const metodoOptions = document.querySelectorAll('input[name="metodo_pago"]');
            const tarjetaCampos = document.getElementById('tarjeta-campos');
            const efectivoMensaje = document.getElementById('efectivo-mensaje');

            metodoOptions.forEach(option => {
                option.addEventListener('change', function() {
                    tarjetaCampos.style.display = 'none';
                    efectivoMensaje.style.display = 'none';
                    
                    // Limpiar campos requeridos
                    document.getElementById('nombre_titular').required = false;

                    if (this.value === 'tarjeta') {
                        tarjetaCampos.style.display = 'block';
                        document.getElementById('nombre_titular').required = true;
                    } else if (this.value === 'efectivo') {
                        efectivoMensaje.style.display = 'block';
                    }
                });
            });

            // Formatear n√∫mero de tarjeta
            const numeroTarjeta = document.getElementById('numero_tarjeta');
            if (numeroTarjeta) {
                numeroTarjeta.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });
            }

            // Formatear fecha de vencimiento
            const fechaVencimiento = document.getElementById('fecha_vencimiento');
            if (fechaVencimiento) {
                fechaVencimiento.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }

            // Solo n√∫meros para CVV
            const cvv = document.getElementById('cvv');
            if (cvv) {
                cvv.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
        });

        // Auto-dismiss flash messages
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(function(message) {
            setTimeout(function() {
                message.classList.add('slide-out');
                
                // Remove element after animation completes
                setTimeout(function() {
                    message.remove();
                }, 300); // Match animation duration
            }, 4000);
            
            // Optional: Add click to dismiss
            message.addEventListener('click', function() {
                message.classList.add('slide-out');
                setTimeout(function() {
                    message.remove();
                }, 300);
            });
            
            // Add cursor pointer to indicate clickable
            message.style.cursor = 'pointer';
        });
    </script>

</body>
</html>

