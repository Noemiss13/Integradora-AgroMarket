<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroMarket - Panel Principal</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navigation-header.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- ===== Men√∫ superior ===== -->
    <nav>
        <div class="nav-left">
            <div class="logo"><h2>AgroMarket</h2></div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="/comprador/panel" class="activo" id="nav-inicio-comprador">Inicio</a>
            <a href="/comprador/productos" id="nav-productos-comprador">Productos</a>
            <a href="/comprador/carrito" id="nav-carrito-comprador">Carrito</a>
            <a href="/auth/perfil">Mi Perfil</a>
            <a href="/auth/logout">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <main class="main-content">
        <!-- Navigation Header -->
        <div class="navigation-header">
            <div></div>
            <div class="breadcrumbs">
                <a href="/comprador/panel">Inicio</a>
            </div>
        </div>
        <!-- ===== Secci√≥n Explora Categor√≠as ===== -->
        <section class="categorias-section">
            {% set titulo = 'Explora categor√≠as' %}
            {% set subtitulo = 'Elige una categor√≠a para descubrir productos frescos de productores locales.' %}
            {% set controles = '<input type="text" placeholder="Buscar productos..." class="search-input"><button class="sort-btn">Ordenar por</button>' %}
            {% include 'components/section_header.html' %}
            
            <div class="categorias-grid" id="categoriasGrid">
                <!-- Loading state para categor√≠as -->
                <div class="loading-categorias" id="loadingCategorias">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando categor√≠as...</p>
                    </div>
                
                <!-- Las categor√≠as se cargar√°n din√°micamente desde Firestore -->
            </div>
        </section>

        <!-- ===== Secci√≥n Recomendaciones ===== -->
        <section class="productos-populares-section">
            {% set titulo = 'Recomendaciones' %}
            {% set subtitulo = 'Productos destacados seleccionados especialmente para ti.' %}
            {% set controles = '<button class="filter-btn">Filtrar</button><button class="sort-btn">Ordenar</button>' %}
            {% include 'components/section_header.html' %}
            
            <!-- Filtros (inicialmente ocultos) -->
            <div class="filters-container" style="display: none;">
                <div class="filter-buttons">
                    <button class="filter-btn active">Todos</button>
                    <button class="filter-btn">Frutas</button>
                    <button class="filter-btn">Verduras</button>
                    <button class="filter-btn">Cereales</button>
                    <button class="filter-btn">Legumbres</button>
                </div>
            </div>
            
            <!-- Loading state -->
            <div class="loading-products" id="loadingProducts">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Cargando productos...</p>
            </div>
            
            <!-- Products grid din√°mico -->
            <div class="productos-populares-grid" id="productosGrid" style="display: none;">
                <!-- Los productos se cargar√°n din√°micamente desde Firestore -->
            </div>
            
            <!-- Empty state -->
            <div class="empty-products" id="emptyProducts" style="display: none;">
                <i class="fas fa-box-open"></i>
                <h3>No hay productos disponibles</h3>
                <p>No se encontraron productos en este momento. Intenta m√°s tarde.</p>
            </div>
        </section>
    </main>

    <!-- ===== Scripts de Firebase ===== -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script>
        // Variables globales
        let db;
        let productos = [];
        const categorias = ['frutas', 'verduras', 'semillas', 'otros'];
        
        // Iconos para categor√≠as
        const categoriaIconos = {
            'frutas': 'üçé',
            'verduras': 'ü•¨',
            'semillas': 'üåæ',
            'otros': 'üì¶'
        };
        
        // Inicializar Firebase
        async function inicializarFirebase() {
            try {
                console.log('üîÑ Inicializando Firebase...');
                
                // Esperar a que Firebase est√© disponible
                let intentos = 0;
                const maxIntentos = 20;
                
                while (typeof firebase === 'undefined' && intentos < maxIntentos) {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    intentos++;
                }
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no se carg√≥');
                }
                
                // Verificar configuraci√≥n
                if (!window.firebaseConfig) {
                    throw new Error('Configuraci√≥n de Firebase no disponible');
                }
                
                // Inicializar Firebase si no est√° inicializado
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(window.firebaseConfig);
                }
                
                db = firebase.firestore();
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true
                });
                
                console.log('‚úÖ Firebase inicializado correctamente');
                return true;
                
                    } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                return false;
            }
        }

        // Contar productos por categor√≠a
        async function contarProductosPorCategoria() {
            try {
                if (!db) {
                    return {};
                }
                
                const productosSnapshot = await db.collection('productos')
                    .where('activo', '==', true)
                    .get();
                
                const conteos = {
                    'todos': 0,
                    'frutas': 0,
                    'verduras': 0,
                    'semillas': 0,
                    'otros': 0
                };
                
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Solo contar productos con stock
                    if ((data.stock || 0) <= 0) {
                    return;
                }
                
                    const categoria = (data.categoria || 'otros').toLowerCase().trim();
                    
                    // Contar en categor√≠a espec√≠fica
                    if (conteos.hasOwnProperty(categoria)) {
                        conteos[categoria]++;
                        } else {
                        conteos['otros']++;
                    }
                    
                    // Contar en "todos"
                    conteos['todos']++;
                });
                
                return conteos;
                
            } catch (error) {
                console.error('‚ùå Error contando productos:', error);
                return {};
            }
        }
        
        // Mostrar categor√≠as con conteos
        async function mostrarCategorias() {
            const categoriasGrid = document.getElementById('categoriasGrid');
            const loadingCategorias = document.getElementById('loadingCategorias');
            
            if (!categoriasGrid) return;
            
            if (loadingCategorias) {
                loadingCategorias.style.display = 'none';
            }
            
            // Obtener conteos de productos
            const conteos = await contarProductosPorCategoria();
            
            // Agregar card de "Todos los productos" al inicio
            const todasLasCategorias = [
                {
                    nombre: 'todos',
                    nombreLegible: 'Todos los productos',
                    icono: 'üõí',
                    url: '/comprador/productos',
                    conteo: conteos['todos'] || 0
                },
                ...categorias.map(categoria => ({
                    nombre: categoria,
                    nombreLegible: categoria.charAt(0).toUpperCase() + categoria.slice(1),
                    icono: categoriaIconos[categoria] || 'üì¶',
                    url: `/comprador/categoria/${categoria.toLowerCase().replace(/\s+/g, '-')}`,
                    conteo: conteos[categoria] || 0
                }))
            ];
            
            const categoriasHTML = todasLasCategorias.map(cat => {
                return `
                    <div class="categoria-card" data-categoria="${cat.nombre}">
                        <a href="${cat.url}" class="categoria-link">
                            <div class="categoria-icon">${cat.icono}</div>
                            <h3>${cat.nombreLegible}</h3>
                            <p class="categoria-count">${cat.conteo} producto${cat.conteo !== 1 ? 's' : ''}</p>
                            <span class="categoria-arrow">Ver todos ‚Üí</span>
                        </a>
                    </div>
            `;
            }).join('');
            
            categoriasGrid.innerHTML = categoriasHTML;
        }
        
        // Cargar productos recomendados
        async function cargarProductosRecomendados() {
            try {
                if (!db) {
                    throw new Error('Base de datos no disponible');
                }
                
                // Limitar a 8 productos para recomendaciones (4 columnas)
                const productosSnapshot = await db.collection('productos')
                    .where('activo', '==', true)
                    .limit(8)
                    .get();
                
                productos = [];
                
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Solo productos con stock
                    if ((data.stock || 0) <= 0) {
                    return;
                }
                
                        let imagenValida = null;
                        if (data.imagen && typeof data.imagen === 'string' && data.imagen.trim() !== '') {
                        try {
                            new URL(data.imagen);
                            imagenValida = data.imagen;
                        } catch (e) {
                            // Imagen inv√°lida
                        }
                        }
                        
                        productos.push({
                            id: doc.id,
                            nombre: data.nombre || 'Sin nombre',
                            precio: data.precio || 0,
                        categoria: data.categoria || 'otros',
                            stock: data.stock || 0,
                            unidad: data.unidad || 'kg',
                            imagen: imagenValida,
                        vendedor_nombre: data.vendedor_nombre || 'N/A',
                        descripcion: data.descripcion || ''
                        });
                });
                
                console.log(`‚úÖ ${productos.length} productos recomendados cargados`);
                mostrarProductosRecomendados(productos);
                
            } catch (error) {
                console.error('‚ùå Error cargando productos:', error);
                mostrarErrorProductos();
            }
        }
        
        // Mostrar productos recomendados con espacios para anuncios
        function mostrarProductosRecomendados(productosParaMostrar) {
            const productosGrid = document.getElementById('productosGrid');
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            
            if (loadingProducts) {
                loadingProducts.style.display = 'none';
            }
            
            if (!productosParaMostrar || productosParaMostrar.length === 0) {
                if (productosGrid) productosGrid.style.display = 'none';
                if (emptyProducts) emptyProducts.style.display = 'block';
                return;
            }
            
                if (emptyProducts) emptyProducts.style.display = 'none';
                if (productosGrid) {
                    productosGrid.style.display = 'grid';
                    
                // Limitar a 8 productos para recomendaciones (4 filas de 4 cards)
                const productosLimitados = productosParaMostrar.slice(0, 8);
                        
                // Crear HTML solo con productos, sin espacios publicitarios
                const productosHTML = productosLimitados.map(producto => {
                        return `
                        <article class="producto-card-popular" data-id="${producto.id}">
                            <a href="/comprador/detalle_producto/${producto.id}" class="producto-link">
                                <div class="producto-image-popular">
                                    ${producto.imagen ? 
                                        `<img src="${producto.imagen}" alt="${producto.nombre}" 
                                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                         <div class="producto-placeholder-popular" style="display: none;">
                                             <i class="fas fa-box"></i>
                                         </div>` :
                                        `<div class="producto-placeholder-popular">
                                             <i class="fas fa-box"></i>
                                         </div>`
                                    }
                                </div>
                                <div class="producto-info-popular">
                                    <h4>${producto.nombre}</h4>
                                    <p class="producto-precio-popular">$${producto.precio.toFixed(2)} / ${producto.unidad}</p>
                                    <p class="producto-vendedor-popular">${producto.vendedor_nombre}</p>
                                </div>
                            </a>
                        </article>
                        `;
                    }).join('');
                    
                productosGrid.innerHTML = productosHTML;
            }
        }
        
        function mostrarErrorProductos() {
            const loadingProducts = document.getElementById('loadingProducts');
            const productosGrid = document.getElementById('productosGrid');
            const emptyProducts = document.getElementById('emptyProducts');
            
            if (loadingProducts) loadingProducts.style.display = 'none';
            if (productosGrid) productosGrid.style.display = 'none';
            if (emptyProducts) {
                emptyProducts.style.display = 'block';
                emptyProducts.querySelector('p').textContent = 'Error al cargar productos. Intenta recargar la p√°gina.';
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Iniciando panel del comprador...');
                
                // Inicializar Firebase primero
                const firebaseInicializado = await inicializarFirebase();
                
                if (firebaseInicializado) {
                    // Mostrar categor√≠as con conteos (necesita Firebase)
                    await mostrarCategorias();
                    
                    // Cargar productos recomendados
                    await cargarProductosRecomendados();
                    console.log('‚úÖ Panel del comprador cargado completamente');
                        } else {
                    mostrarErrorProductos();
                    // Mostrar categor√≠as sin conteos si Firebase falla
                    mostrarCategorias();
                        }
                } catch (error) {
                console.error('‚ùå Error en panel del comprador:', error);
                mostrarErrorProductos();
            }
        });
    </script>

    <!-- PWA Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("{{ url_for('static', filename='js/service-worker.js') }}")
        .then(reg => console.log("‚úÖ Service Worker registrado:", reg))
        .catch(err => console.error("‚ùå Error al registrar SW:", err));
      }
    </script>
</body>
</html>
