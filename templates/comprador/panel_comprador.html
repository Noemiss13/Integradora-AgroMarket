<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroMarket - Panel Principal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Clase para elementos solo para lectores de pantalla */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- ===== Men√∫ superior ===== -->
    <nav>
        <div class="nav-left">
            <div class="logo"><h2>AgroMarket</h2></div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="/comprador/panel" class="activo" id="nav-inicio-comprador">Inicio</a>
            <a href="/comprador/productos" id="nav-productos-comprador">Productos</a>
            <a href="/comprador/carrito" id="nav-carrito-comprador">Carrito</a>
            <a href="/auth/perfil">Mi Perfil</a>
            <a href="/auth/logout">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <main class="main-content">
        <!-- ===== Secci√≥n Explora Categor√≠as ===== -->
        <section class="categorias-section">
            {% set titulo = 'Explora categor√≠as' %}
            {% set subtitulo = 'Elige una categor√≠a para descubrir productos frescos de productores locales.' %}
            {% set controles = '<input type="text" placeholder="Buscar productos..." class="search-input"><button class="sort-btn">Ordenar por</button>' %}
            {% include 'components/section_header.html' %}
            
            <div class="categorias-grid" id="categoriasGrid">
                <!-- Loading state para categor√≠as -->
                <div class="loading-categorias" id="loadingCategorias">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando categor√≠as...</p>
                    </div>
                
                <!-- Las categor√≠as se cargar√°n din√°micamente desde Firestore -->
            </div>
        </section>

        <!-- ===== Secci√≥n Recomendaciones ===== -->
        <section class="productos-populares-section">
            {% set titulo = 'Recomendaciones' %}
            {% set subtitulo = 'Productos destacados seleccionados especialmente para ti.' %}
            {% set controles = '<button class="filter-btn">Filtrar</button><button class="sort-btn">Ordenar</button>' %}
            {% include 'components/section_header.html' %}
            
            <!-- Filtros (inicialmente ocultos) -->
            <div class="filters-container" style="display: none;">
                <div class="filter-buttons">
                    <button class="filter-btn active">Todos</button>
                    <button class="filter-btn">Frutas</button>
                    <button class="filter-btn">Verduras</button>
                    <button class="filter-btn">Cereales</button>
                    <button class="filter-btn">Legumbres</button>
                </div>
            </div>
            
            <!-- Loading state -->
            <div class="loading-products" id="loadingProducts">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Cargando productos...</p>
            </div>
            
            <!-- Products grid din√°mico -->
            <div class="productos-populares-grid" id="productosGrid" style="display: none;">
                <!-- Los productos se cargar√°n din√°micamente desde Firestore -->
            </div>
            
            <!-- Empty state -->
            <div class="empty-products" id="emptyProducts" style="display: none;">
                <i class="fas fa-box-open"></i>
                <h3>No hay productos disponibles</h3>
                <p>No se encontraron productos en este momento. Intenta m√°s tarde.</p>
            </div>
        </section>
    </main>

    <!-- ===== Scripts de Firebase ===== -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script>
        // Variables globales
        let auth = null;
        let db = null;
        let productos = [];
        let categorias = [];


        // Actualiza el saludo del usuario usando Firebase Auth/Firestore
        function actualizarSaludoUsuario() {
            try {
                if (typeof firebase === 'undefined') return; // SDK a√∫n no cargado
                const strongEl = document.querySelector('.saludo-usuario strong');
                if (!strongEl) return;

                firebase.auth().onAuthStateChanged(async (user) => {
                    try {
                        if (!user) return;
                        let nombre = user.displayName || null;

                        // Fallback: intenta obtener nombre desde Firestore si existe
                        if (!nombre && db) {
                            try {
                                const doc = await db.collection('usuarios').doc(user.uid).get();
                                if (doc.exists) {
                                    const data = doc.data() || {};
                                    nombre = data.nombre || data.nombre_completo || null;
                                }
                            } catch (e) {
                                console.log('‚ö†Ô∏è No se pudo leer nombre desde Firestore:', e.message);
                            }
                        }

                        // √öltimo fallback: parte local del correo
                        if (!nombre && user.email) {
                            nombre = user.email.split('@')[0];
                        }

                        if (nombre) strongEl.textContent = nombre;
                    } catch (err) {
                        console.log('‚ö†Ô∏è Error actualizando saludo:', err.message);
                    }
                });
            } catch (e) {
                console.log('‚ö†Ô∏è actualizarSaludoUsuario no disponible:', e.message);
            }
        }

        // Funci√≥n para inicializar Firebase
        async function inicializarFirebase() {
            try {
                console.log('üîÑ Inicializando Firebase...');
                console.log('üîç Estado inicial:', {
                    firebase: typeof firebase,
                    firebaseConfig: !!window.firebaseConfig,
                    config: window.firebaseConfig
                });
                
                // Esperar a que Firebase est√© disponible
                let intentos = 0;
                const maxIntentos = 20;
                
                while (typeof firebase === 'undefined' && intentos < maxIntentos) {
                    console.log(`‚è≥ Esperando Firebase... (intento ${intentos + 1}/${maxIntentos})`);
                    await new Promise(resolve => setTimeout(resolve, 250));
                    intentos++;
                }
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no se carg√≥ despu√©s de 5 segundos');
                }
                
                console.log('‚úÖ Firebase SDK disponible');
                console.log('üîç Firebase apps:', firebase.apps.length);
                
                // Verificar que la configuraci√≥n est√© disponible
                if (!window.firebaseConfig) {
                    throw new Error('Configuraci√≥n de Firebase no disponible');
                }
                
                console.log('‚úÖ Configuraci√≥n de Firebase disponible:', window.firebaseConfig);
                
                // Inicializar Firebase si no est√° inicializado
                if (firebase.apps.length === 0) {
                    console.log('üîÑ Inicializando nueva instancia de Firebase...');
                    firebase.initializeApp(window.firebaseConfig);
                    console.log('‚úÖ Firebase inicializado');
                } else {
                    console.log('‚úÖ Firebase ya estaba inicializado');
                }
                
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log('üîç Auth y DB inicializados:', { auth: !!auth, db: !!db });
                
                
                // Configuraciones de rendimiento
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true
                });
                
                console.log('‚úÖ Firebase configurado correctamente');
                return true;
                
                    } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                console.error('‚ùå Stack trace:', error.stack);
                return false;
            }
        }

        // Funci√≥n para cargar categor√≠as desde Firestore
        async function cargarCategorias() {
            try {
                console.log('üîÑ Cargando categor√≠as desde Firestore...');
                console.log('üîç DB disponible:', !!db);
                
                if (!db) {
                    throw new Error('Base de datos de Firestore no est√° disponible');
                }
                
                mostrarLoadingCategorias(true);
                
                console.log('üîç Ejecutando consulta de categor√≠as a Firestore...');
                
                // Obtener productos para extraer categor√≠as √∫nicas
                const productosSnapshot = await db.collection('productos')
                    .where('activo', '==', true)
                    .get();
                
                console.log('üìä Productos encontrados para categor√≠as:', productosSnapshot.size);
                console.log('üîç Documentos de categor√≠as:', productosSnapshot.docs.length);
                
                if (productosSnapshot.empty) {
                    console.log('‚ö†Ô∏è No hay productos en la base de datos para categor√≠as');
                    mostrarCategorias([{ nombre: 'Todos los productos', count: 0, icon: 'fas fa-th-large' }]);
                    return;
                }
                
                // Extraer categor√≠as √∫nicas y contar productos
                const categoriasMap = new Map();
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    const categoria = data.categoria || 'otros';
                    console.log('üìÑ Categor√≠a encontrada:', { docId: doc.id, categoria: categoria, activo: data.activo, stock: data.stock });
                    
                    // Solo contar productos activos y con stock
                    if (data.activo === true && data.stock > 0) {
                        if (categoriasMap.has(categoria)) {
                            categoriasMap.set(categoria, categoriasMap.get(categoria) + 1);
                        } else {
                            categoriasMap.set(categoria, 1);
                        }
                    }
                });
                
                console.log('üìä Categor√≠as mapeadas:', Array.from(categoriasMap.entries()));
                
                // Contar total de productos activos y con stock
                const totalProductosActivos = Array.from(categoriasMap.values()).reduce((sum, count) => sum + count, 0);
                
                // Convertir a array y agregar "Todos los productos"
                categorias = [
                    { nombre: 'Todos los productos', count: totalProductosActivos, icon: 'fas fa-th-large' },
                    ...Array.from(categoriasMap.entries()).map(([nombre, count]) => ({
                        nombre: nombre.charAt(0).toUpperCase() + nombre.slice(1),
                        count: count,
                        icon: getCategoriaIcon(nombre)
                    }))
                ];
                
                console.log(`‚úÖ ${categorias.length} categor√≠as cargadas:`, categorias);
                mostrarCategorias(categorias);
                
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                mostrarErrorCategorias('Error al cargar categor√≠as. Intenta recargar la p√°gina.');
            }
        }

        // Funci√≥n para obtener icono de categor√≠a
        function getCategoriaIcon(categoria) {
            const iconos = {
                'frutas': 'fas fa-apple-alt',
                'verduras': 'fas fa-carrot',
                'cereales': 'fas fa-seedling',
                'legumbres': 'fas fa-peas',
                'hortalizas': 'fas fa-leaf',
                'tub√©rculos': 'fas fa-potato',
                'otros': 'fas fa-box'
            };
            return iconos[categoria.toLowerCase()] || 'fas fa-box';
        }

        // Funci√≥n para mostrar categor√≠as
        function mostrarCategorias(categoriasParaMostrar) {
            console.log('üè∑Ô∏è Mostrando categor√≠as:', categoriasParaMostrar);
            console.log('üîç Cantidad de categor√≠as:', categoriasParaMostrar ? categoriasParaMostrar.length : 0);
            
            const categoriasGrid = document.getElementById('categoriasGrid');
            const loadingCategorias = document.getElementById('loadingCategorias');
            
            console.log('üîç Elementos DOM:', {
                categoriasGrid: !!categoriasGrid,
                loadingCategorias: !!loadingCategorias
            });
            
            if (!categoriasGrid) {
                console.error('‚ùå No se encontr√≥ el elemento categoriasGrid');
                return;
            }
            
            // Ocultar loading
            mostrarLoadingCategorias(false);
            
            const categoriasHTML = categoriasParaMostrar.map(categoria => {
                console.log(`üè∑Ô∏è Procesando categor√≠a: ${categoria.nombre} (${categoria.count} productos)`);
                // Generar URL correcta seg√∫n la categor√≠a
                let categoriaUrl;
                if (categoria.nombre === 'Todos los productos') {
                    categoriaUrl = '/comprador/productos';
                } else {
                    // Convertir a lowercase y reemplazar todos los espacios con guiones
                    const categoriaSlug = categoria.nombre.toLowerCase().replace(/\s+/g, '-');
                    categoriaUrl = `/comprador/categoria/${categoriaSlug}`;
                }
                
                return `
                <a href="${categoriaUrl}" class="categoria-card ${categoria.nombre === 'Todos los productos' ? 'todos-productos-card' : ''}">
                    <div class="categoria-header">
                        <h3>${categoria.nombre}</h3>
                        <span class="product-count">${categoria.count}</span>
                    </div>
                    <div class="categoria-image">
                        <div class="categoria-icon">
                            <i class="${categoria.icon}"></i>
                        </div>
                        <div class="categoria-tag">${categoria.nombre === 'Todos los productos' ? 'COMPLETO' : 'DISPONIBLE'}</div>
                    </div>
                </a>
            `;
            }).join('');
            
            console.log('üìù HTML de categor√≠as generado:', categoriasHTML.substring(0, 200) + '...');
            categoriasGrid.innerHTML = categoriasHTML;
            
            // Verificar que se insert√≥ correctamente
            const cardsInsertadas = categoriasGrid.querySelectorAll('.categoria-card');
            console.log(`‚úÖ Categor√≠as mostradas en el DOM: ${cardsInsertadas.length} cards`);
        }

        // Funci√≥n para mostrar/ocultar loading de categor√≠as
        function mostrarLoadingCategorias(mostrar) {
            const loadingCategorias = document.getElementById('loadingCategorias');
            if (mostrar) {
                loadingCategorias.style.display = 'flex';
            } else {
                loadingCategorias.style.display = 'none';
            }
        }

        // Funci√≥n para mostrar error de categor√≠as
        function mostrarErrorCategorias(mensaje) {
            const categoriasGrid = document.getElementById('categoriasGrid');
            const loadingCategorias = document.getElementById('loadingCategorias');
            
            loadingCategorias.style.display = 'none';
            categoriasGrid.innerHTML = `
                <div class="error-categorias">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error</h3>
                    <p>${mensaje}</p>
                    <button onclick="cargarCategorias()" class="btn-retry">
                        <i class="fas fa-refresh"></i> Reintentar
                    </button>
                </div>
            `;
        }

        // Funci√≥n para cargar productos desde Firestore
        async function cargarProductos() {
            try {
                console.log('üîÑ Cargando productos desde Firestore...');
                console.log('üîç DB disponible:', !!db);
                
                if (!db) {
                    throw new Error('Base de datos de Firestore no est√° disponible');
                }
                
                mostrarLoading(true);
                
                console.log('üîç Ejecutando consulta a Firestore...');
                
                // Consulta simple sin filtros complejos
                const productosSnapshot = await db.collection('productos').limit(6).get();
                
                console.log('üìä Productos encontrados:', productosSnapshot.size);
                console.log('üîç Documentos:', productosSnapshot.docs.length);
                
                if (productosSnapshot.empty) {
                    console.log('‚ö†Ô∏è No hay productos en la base de datos');
                    mostrarProductos([]);
                    return;
                }
                
                productos = [];
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üìÑ Producto:', { id: doc.id, nombre: data.nombre, activo: data.activo, stock: data.stock });
                    
                    // Solo incluir productos activos y con stock
                    if (data.activo === true && data.stock > 0) {
                        // Verificar si la imagen es v√°lida
                        let imagenValida = null;
                        if (data.imagen && typeof data.imagen === 'string' && data.imagen.trim() !== '') {
                            imagenValida = data.imagen;
                            console.log('‚úÖ Imagen v√°lida para', data.nombre, ':', data.imagen);
                        } else {
                            console.log('‚ùå Imagen inv√°lida para', data.nombre, ':', data.imagen);
                        }
                        
                        productos.push({
                            id: doc.id,
                            nombre: data.nombre || 'Sin nombre',
                            precio: data.precio || 0,
                            categoria: data.categoria || 'Sin categor√≠a',
                            stock: data.stock || 0,
                            unidad: data.unidad || 'kg',
                            imagen: imagenValida,
                            vendedor_nombre: data.vendedor_nombre || 'N/A'
                        });
                    }
                });
                
                console.log(`‚úÖ ${productos.length} productos v√°lidos encontrados:`, productos);
                mostrarProductos(productos);
                
            } catch (error) {
                console.error('‚ùå Error cargando productos:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                mostrarError('Error al cargar productos. Intenta recargar la p√°gina.');
            }
        }

        // Funci√≥n para mostrar productos
        function mostrarProductos(productosParaMostrar) {
            console.log('üõçÔ∏è Mostrando productos:', productosParaMostrar);
            console.log('üîç Tipo de productosParaMostrar:', typeof productosParaMostrar);
            console.log('üîç Es array:', Array.isArray(productosParaMostrar));
            console.log('üîç Longitud:', productosParaMostrar ? productosParaMostrar.length : 'undefined');
            
            const productosGrid = document.getElementById('productosGrid');
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            
            console.log('üîç Elementos del DOM:');
            console.log('- productosGrid:', productosGrid);
            console.log('- loadingProducts:', loadingProducts);
            console.log('- emptyProducts:', emptyProducts);
            
            if (!productosGrid) {
                console.error('‚ùå No se encontr√≥ el elemento productosGrid');
                return;
            }
            
            // Ocultar loading
            mostrarLoading(false);
            
            if (!productosParaMostrar || productosParaMostrar.length === 0) {
                console.log('‚ö†Ô∏è No hay productos para mostrar');
                if (productosGrid) productosGrid.style.display = 'none';
                if (emptyProducts) emptyProducts.style.display = 'flex';
                return;
            }
            
            console.log(`üìä Mostrando ${productosParaMostrar.length} productos`);
            console.log('üîç Primer producto:', productosParaMostrar[0]);
            
            // Mostrar productos
            if (emptyProducts) emptyProducts.style.display = 'none';
            if (productosGrid) productosGrid.style.display = 'grid';
            
            const productosHTML = productosParaMostrar.map(producto => {
                console.log('üñºÔ∏è Procesando imagen para:', producto.nombre, 'URL:', producto.imagen);
                console.log('üîç Detalles de imagen:', {
                    tieneImagen: !!producto.imagen,
                    esString: typeof producto.imagen === 'string',
                    noVacia: producto.imagen && producto.imagen.trim() !== '',
                    longitud: producto.imagen ? producto.imagen.length : 0
                });
                
                // Funci√≥n para manejar errores de imagen
                const manejarErrorImagen = (img) => {
                    console.log('‚ùå Error cargando imagen:', img.src);
                    console.log('üîÑ Cambiando a placeholder...');
                    img.src = '/static/images/product-placeholder.png';
                    img.onerror = null; // Evitar bucle infinito
                };
                
                // Funci√≥n para manejar carga exitosa de imagen
                const manejarCargaImagen = (img) => {
                    console.log('‚úÖ Imagen cargada exitosamente:', img.src);
                    console.log('üìè Dimensiones:', img.naturalWidth + 'x' + img.naturalHeight);
                };
                
                // Usar la misma l√≥gica que la vista del vendedor (m√°s simple y efectiva)
                const imagenUrl = producto.imagen || '/static/images/product-placeholder.png';
                
                let contenidoImagen;
                if (producto.imagen && typeof producto.imagen === 'string' && producto.imagen.trim() !== '') {
                    console.log('‚úÖ Usando imagen real para:', producto.nombre);
                    contenidoImagen = `
                        <img src="${producto.imagen}" alt="${producto.nombre}" class="producto-image" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             onload="console.log('‚úÖ Imagen cargada:', '${producto.nombre}')">
                        <div class="producto-placeholder" style="display: none;">
                            <i class="fas fa-box"></i>
                        </div>`;
                } else {
                    console.log('‚ö†Ô∏è Usando placeholder para:', producto.nombre);
                    contenidoImagen = `
                        <div class="producto-placeholder">
                            <i class="fas fa-box"></i>
                        </div>`;
                }
                
                return `
                <article class="producto-card-popular">
                    <a href="/comprador/detalle_producto/${producto.id}" class="producto-link">
                        <div class="producto-image">
                            ${contenidoImagen}
                        </div>
                        
                        <div class="producto-info">
                            <h3>${producto.nombre || 'Sin nombre'}</h3>
                            <p class="producto-categoria">${producto.categoria || 'Sin categor√≠a'}</p>
                            <div class="producto-precio">
                                <span class="precio">$${producto.precio || 0}</span>
                                <span class="unidad">/${producto.unidad || 'kg'}</span>
                            </div>
                            <div class="producto-stock">
                                <span class="stock">Stock: ${producto.stock || 0} ${producto.unidad || 'kg'}</span>
                            </div>
                            <div class="producto-vendedor">
                                <small>Vendedor: ${producto.vendedor_nombre || 'N/A'}</small>
                            </div>
                        </div>
                    </a>
                </article>
                `;
            }).join('');
            
            console.log('üìù HTML de productos generado:', productosHTML.substring(0, 200) + '...');
            console.log('üìè Longitud del HTML:', productosHTML.length);
            
            // Verificar el estado del grid antes de insertar
            console.log('üîç Estado del grid antes de insertar:', {
                display: productosGrid.style.display,
                innerHTML: productosGrid.innerHTML.length,
                children: productosGrid.children.length
            });
            
            productosGrid.innerHTML = productosHTML;
            
            // Verificar el estado del grid despu√©s de insertar
            console.log('üîç Estado del grid despu√©s de insertar:', {
                display: productosGrid.style.display,
                innerHTML: productosGrid.innerHTML.length,
                children: productosGrid.children.length
            });
            
            // Forzar re-renderizado
            productosGrid.style.display = 'none';
            productosGrid.offsetHeight; // Trigger reflow
            productosGrid.style.display = 'grid';
            
            console.log('‚úÖ Productos mostrados en el DOM');
            console.log('üéØ Cards visibles:', document.querySelectorAll('.producto-card-popular').length);
        }

        // Funci√≥n para mostrar/ocultar loading
        function mostrarLoading(mostrar) {
            const loadingProducts = document.getElementById('loadingProducts');
            const productosGrid = document.getElementById('productosGrid');
            const emptyProducts = document.getElementById('emptyProducts');
            
            if (mostrar) {
                loadingProducts.style.display = 'flex';
                productosGrid.style.display = 'none';
                emptyProducts.style.display = 'none';
            } else {
                loadingProducts.style.display = 'none';
            }
        }

        // Funci√≥n para mostrar error
        function mostrarError(mensaje) {
            console.log('‚ùå Mostrando error:', mensaje);
            
            const productosGrid = document.getElementById('productosGrid');
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            
            console.log('üîç Elementos para error:');
            console.log('- productosGrid:', productosGrid);
            console.log('- loadingProducts:', loadingProducts);
            console.log('- emptyProducts:', emptyProducts);
            
            if (loadingProducts) loadingProducts.style.display = 'none';
            if (productosGrid) productosGrid.style.display = 'none';
            if (emptyProducts) {
                emptyProducts.style.display = 'flex';
                emptyProducts.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error</h3>
                    <p>${mensaje}</p>
                    <button onclick="cargarProductos()" class="btn-retry">
                        <i class="fas fa-refresh"></i> Reintentar
                    </button>
                `;
            }
        }

        // Funci√≥n para alternar filtros
        function toggleFilters() {
            const filtersContainer = document.getElementById('filtersContainer');
            filtersContainer.style.display = filtersContainer.style.display === 'none' ? 'block' : 'none';
        }

        // Funci√≥n para alternar ordenamiento
        function toggleSort() {
            alert('Funci√≥n de ordenamiento pr√≥ximamente');
        }

        // Funci√≥n para probar la conexi√≥n con Firestore
        async function probarConexionFirestore() {
            try {
                console.log('üß™ Probando conexi√≥n con Firestore...');
                
                if (!db) {
                    console.log('‚ùå DB no est√° disponible');
                    return false;
                }
                
                // Intentar una consulta simple
                const testSnapshot = await db.collection('productos').limit(1).get();
                console.log('‚úÖ Conexi√≥n exitosa con Firestore');
                console.log('üìä Documentos de prueba:', testSnapshot.size);
                
                if (!testSnapshot.empty) {
                    const testDoc = testSnapshot.docs[0];
                    console.log('üìÑ Documento de prueba:', { id: testDoc.id, data: testDoc.data() });
                }
                
                // Probar consulta con filtros
                console.log('üîç Probando consulta con filtros...');
                const filteredSnapshot = await db.collection('productos')
                    .where('activo', '==', true)
                    .where('stock', '>', 0)
                    .limit(3)
                    .get();
                
                console.log('üìä Productos filtrados encontrados:', filteredSnapshot.size);
                filteredSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üìÑ Producto filtrado:', { 
                        id: doc.id, 
                        nombre: data.nombre,
                        activo: data.activo,
                        stock: data.stock,
                        categoria: data.categoria
                    });
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error probando conexi√≥n con Firestore:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    code: error.code
                });
                return false;
            }
        }

        // Funci√≥n de prueba simple
        async function pruebaSimple() {
            try {
                console.log('üß™ PRUEBA SIMPLE - Iniciando...');
                
                // 1. Verificar Firebase
                if (typeof firebase === 'undefined') {
                    console.log('‚ùå Firebase no est√° disponible');
                    return;
                }
                console.log('‚úÖ Firebase disponible');
                
                // 2. Inicializar si es necesario
                if (!db) {
                    console.log('üîÑ Inicializando Firebase...');
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                console.log('‚úÖ Firestore disponible');
                
                // 3. Consulta simple sin filtros
                console.log('üîç Haciendo consulta simple...');
                const snapshot = await db.collection('productos').limit(3).get();
                console.log('üìä Documentos encontrados:', snapshot.size);
                
                if (snapshot.empty) {
                    console.log('‚ö†Ô∏è No hay productos en la base de datos');
                    return;
                }
                
                // 4. Mostrar los primeros 3 productos directamente
                const productos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üìÑ Procesando producto:', { 
                        id: doc.id, 
                        nombre: data.nombre, 
                        imagen: data.imagen,
                        tieneImagen: !!data.imagen,
                        imagenVacia: data.imagen === '',
                        imagenNull: data.imagen === null,
                        imagenUndefined: data.imagen === undefined
                    });
                    
                    // Verificar si la imagen es v√°lida
                    let imagenValida = null;
                    if (data.imagen && typeof data.imagen === 'string' && data.imagen.trim() !== '') {
                        // Verificar que sea una URL v√°lida
                        try {
                            new URL(data.imagen);
                            imagenValida = data.imagen;
                            console.log('‚úÖ Imagen v√°lida para', data.nombre, ':', data.imagen);
                        } catch (e) {
                            console.log('‚ùå URL de imagen inv√°lida para', data.nombre, ':', data.imagen);
                        }
                    } else {
                        console.log('‚ùå Imagen vac√≠a o nula para', data.nombre, ':', data.imagen);
                    }
                    
                    productos.push({
                        id: doc.id,
                        nombre: data.nombre || 'Sin nombre',
                        precio: data.precio || 0,
                        categoria: data.categoria || 'Sin categor√≠a',
                        stock: data.stock || 0,
                        unidad: data.unidad || 'kg',
                        imagen: imagenValida,
                        vendedor_nombre: data.vendedor_nombre || 'N/A'
                    });
                });
                
                console.log('üì¶ Productos procesados:', productos);
                
                // 5. Mostrar directamente en el DOM
                const productosGrid = document.getElementById('productosGrid');
                const emptyProducts = document.getElementById('emptyProducts');
                const loadingProducts = document.getElementById('loadingProducts');
                
                if (loadingProducts) loadingProducts.style.display = 'none';
                if (emptyProducts) emptyProducts.style.display = 'none';
                if (productosGrid) {
                    productosGrid.style.display = 'grid';
                    
                    const html = productos.map(producto => {
                        console.log('üñºÔ∏è Procesando imagen para:', producto.nombre, 'URL:', producto.imagen);
                        
                        // Usar la misma l√≥gica simple que la vista del vendedor
                        const imagenUrl = producto.imagen || '/static/images/product-placeholder.png';
                        
                        return `
                        <article class="producto-card-popular">
                            <a href="/comprador/detalle_producto/${producto.id}" class="producto-link">
                                <div class="producto-image">
                                    ${producto.imagen && producto.imagen.trim() !== '' ? 
                                        `<img src="${producto.imagen}" alt="${producto.nombre}" class="producto-image" 
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                             onload="console.log('‚úÖ Imagen cargada:', '${producto.nombre}')">
                                         <div class="producto-placeholder" style="display: none;">
                                             <i class="fas fa-box"></i>
                                         </div>` :
                                        `<div class="producto-placeholder">
                                             <i class="fas fa-box"></i>
                                         </div>`
                                    }
                                </div>
                                <div class="producto-info">
                                    <h3>${producto.nombre}</h3>
                                    <p class="producto-categoria">${producto.categoria}</p>
                                    <div class="producto-precio">
                                        <span class="precio">$${producto.precio}</span>
                                        <span class="unidad">/${producto.unidad}</span>
                                    </div>
                                    <div class="producto-stock">
                                        <span class="stock">Stock: ${producto.stock} ${producto.unidad}</span>
                                    </div>
                                    <div class="producto-vendedor">
                                        <small>Vendedor: ${producto.vendedor_nombre}</small>
                                    </div>
                                </div>
                            </a>
                        </article>
                        `;
                    }).join('');
                    
                    productosGrid.innerHTML = html;
                    console.log('‚úÖ Productos mostrados en el DOM');
                }
                
            } catch (error) {
                console.error('‚ùå Error en prueba simple:', error);
            }
        }

        // Funci√≥n para verificar im√°genes de todos los productos
        async function verificarImagenes() {
            try {
                console.log('üñºÔ∏è VERIFICANDO IM√ÅGENES - Iniciando...');
                
                if (!db) {
                    console.log('‚ùå DB no est√° disponible, inicializando Firebase...');
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                
                // Obtener todos los productos
                const snapshot = await db.collection('productos').get();
                console.log('üìä Total de productos en la base de datos:', snapshot.size);
                
                let productosConImagen = 0;
                let productosSinImagen = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const nombre = data.nombre || 'Sin nombre';
                    const imagen = data.imagen;
                    
                    console.log('üîç Producto:', nombre);
                    console.log('  - Imagen:', imagen);
                    console.log('  - Tipo:', typeof imagen);
                    console.log('  - Es string:', typeof imagen === 'string');
                    console.log('  - No es null:', imagen !== null);
                    console.log('  - No es undefined:', imagen !== undefined);
                    console.log('  - No est√° vac√≠a:', imagen !== '');
                    console.log('  - Trim no vac√≠o:', imagen && imagen.trim() !== '');
                    
                    if (imagen && typeof imagen === 'string' && imagen.trim() !== '') {
                        productosConImagen++;
                        console.log('  ‚úÖ TIENE IMAGEN V√ÅLIDA');
                        
                        // Probar si la imagen se puede cargar
                        const img = new Image();
                        img.onload = () => {
                            console.log('  ‚úÖ IMAGEN SE CARGA CORRECTAMENTE:', imagen);
                        };
                        img.onerror = () => {
                            console.log('  ‚ùå ERROR AL CARGAR IMAGEN:', imagen);
                        };
                        img.src = imagen;
                        
                    } else {
                        productosSinImagen++;
                        console.log('  ‚ùå NO TIENE IMAGEN V√ÅLIDA');
                    }
                    console.log('---');
                });
                
                console.log('üìä RESUMEN:');
                console.log(`  - Productos con imagen: ${productosConImagen}`);
                console.log(`  - Productos sin imagen: ${productosSinImagen}`);
                console.log(`  - Total: ${snapshot.size}`);
                
            } catch (error) {
                console.error('‚ùå Error verificando im√°genes:', error);
            }
        }

        // Funci√≥n para probar carga de im√°genes individualmente
        function probarCargaImagenesIndividual() {
            try {
                console.log('üñºÔ∏è PROBANDO CARGA DE IM√ÅGENES INDIVIDUALMENTE...');
                
                if (!db) {
                    console.log('‚ùå DB no est√° disponible, inicializando Firebase...');
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                
                // Obtener productos de Firestore
                db.collection('productos').limit(10).get().then(snapshot => {
                    console.log('üìä Productos obtenidos para prueba:', snapshot.size);
                    
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const nombre = data.nombre || 'Sin nombre';
                        const imagen = data.imagen;
                        
                        console.log(`\nüñºÔ∏è PRODUCTO ${index + 1}: ${nombre}`);
                        console.log('  - URL de imagen:', imagen);
                        console.log('  - Tipo:', typeof imagen);
                        console.log('  - Longitud:', imagen ? imagen.length : 0);
                        
                        if (imagen && typeof imagen === 'string' && imagen.trim() !== '') {
                            // Crear imagen de prueba
                            const img = new Image();
                            
                            img.onload = () => {
                                console.log(`  ‚úÖ IMAGEN ${index + 1} CARGADA:`, {
                                    src: img.src,
                                    width: img.naturalWidth,
                                    height: img.naturalHeight,
                                    complete: img.complete
                                });
                            };
                            
                            img.onerror = () => {
                                console.log(`  ‚ùå ERROR EN IMAGEN ${index + 1}:`, {
                                    src: img.src,
                                    error: 'No se pudo cargar'
                                });
                            };
                            
                            // Intentar cargar
                            img.src = imagen;
                            
                        } else {
                            console.log(`  ‚ö†Ô∏è PRODUCTO ${index + 1} SIN IMAGEN V√ÅLIDA`);
                        }
                    });
                }).catch(error => {
                    console.error('‚ùå Error obteniendo productos:', error);
                });
                
            } catch (error) {
                console.error('‚ùå Error probando carga de im√°genes individual:', error);
            }
        }

        // Funci√≥n para diagnosticar problemas de im√°genes
        function diagnosticarImagenes() {
            try {
                console.log('üîç DIAGNOSTICANDO PROBLEMAS DE IM√ÅGENES...');
                
                // 1. Verificar todas las im√°genes en el DOM
                const imagenes = document.querySelectorAll('.producto-image img');
                console.log('üñºÔ∏è Im√°genes encontradas en el DOM:', imagenes.length);
                
                imagenes.forEach((img, index) => {
                    console.log(`\nüì∏ IMAGEN ${index + 1}:`);
                    console.log('  - src:', img.src);
                    console.log('  - alt:', img.alt);
                    console.log('  - complete:', img.complete);
                    console.log('  - naturalWidth:', img.naturalWidth);
                    console.log('  - naturalHeight:', img.naturalHeight);
                    console.log('  - display:', window.getComputedStyle(img).display);
                    console.log('  - visibility:', window.getComputedStyle(img).visibility);
                    console.log('  - opacity:', window.getComputedStyle(img).opacity);
                    console.log('  - parent display:', window.getComputedStyle(img.parentElement).display);
                    
                    // Verificar si la imagen se carg√≥ correctamente
                    if (img.complete) {
                        if (img.naturalWidth > 0) {
                            console.log('  ‚úÖ Imagen cargada correctamente');
                        } else {
                            console.log('  ‚ùå Imagen no se carg√≥ (naturalWidth = 0)');
                        }
                    } else {
                        console.log('  ‚è≥ Imagen a√∫n cargando...');
                    }
                });
                
                // 2. Verificar placeholders
                const placeholders = document.querySelectorAll('.producto-placeholder');
                console.log('\nüì¶ Placeholders encontrados:', placeholders.length);
                
                placeholders.forEach((placeholder, index) => {
                    console.log(`  üì¶ Placeholder ${index + 1}:`, {
                        display: window.getComputedStyle(placeholder).display,
                        visibility: window.getComputedStyle(placeholder).visibility,
                        parent: placeholder.parentElement.className
                    });
                });
                
                // 3. Verificar contenedores de im√°genes
                const contenedoresImagen = document.querySelectorAll('.producto-image');
                console.log('\nüñºÔ∏è Contenedores de imagen:', contenedoresImagen.length);
                
                contenedoresImagen.forEach((contenedor, index) => {
                    console.log(`  üñºÔ∏è Contenedor ${index + 1}:`, {
                        display: window.getComputedStyle(contenedor).display,
                        visibility: window.getComputedStyle(contenedor).visibility,
                        height: window.getComputedStyle(contenedor).height,
                        width: window.getComputedStyle(contenedor).width,
                        children: contenedor.children.length,
                        hasImg: contenedor.querySelector('img') !== null,
                        hasPlaceholder: contenedor.querySelector('.producto-placeholder') !== null
                    });
                });
                
                // 4. Verificar cards completas
                const cards = document.querySelectorAll('.producto-card-popular');
                console.log('\nüì¶ Cards encontradas:', cards.length);
                
                cards.forEach((card, index) => {
                    const imagen = card.querySelector('.producto-image img');
                    const placeholder = card.querySelector('.producto-placeholder');
                    const nombre = card.querySelector('h3')?.textContent || 'Sin nombre';
                    
                    console.log(`  üì¶ Card ${index + 1} (${nombre}):`, {
                        display: window.getComputedStyle(card).display,
                        visibility: window.getComputedStyle(card).visibility,
                        hasImage: !!imagen,
                        hasPlaceholder: !!placeholder,
                        imageSrc: imagen ? imagen.src : 'N/A',
                        imageComplete: imagen ? imagen.complete : 'N/A'
                    });
                });
                
                console.log('\n‚úÖ Diagn√≥stico completado');
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico de im√°genes:', error);
            }
        }

        // Funci√≥n para limpiar cach√© de im√°genes espec√≠ficamente
        function limpiarCacheImagenes() {
            try {
                console.log('üñºÔ∏è LIMPIANDO CACH√â DE IM√ÅGENES...');
                
                // Obtener todas las im√°genes de productos
                const imagenes = document.querySelectorAll('.producto-image img');
                console.log('üñºÔ∏è Im√°genes encontradas:', imagenes.length);
                
                imagenes.forEach((img, index) => {
                    const srcOriginal = img.src;
                    console.log(`  üñºÔ∏è Imagen ${index + 1}:`, srcOriginal);
                    
                    // Agregar timestamp para forzar recarga
                    const url = new URL(srcOriginal);
                    url.searchParams.set('t', Date.now());
                    img.src = url.toString();
                    
                    console.log(`  üîÑ Nueva URL:`, img.src);
                });
                
                // Tambi√©n limpiar cach√© del navegador si es posible
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                            console.log('üóëÔ∏è Cach√© eliminado:', name);
                        });
                    });
                }
                
                console.log('‚úÖ Cach√© de im√°genes limpiado');
                
            } catch (error) {
                console.error('‚ùå Error limpiando cach√© de im√°genes:', error);
            }
        }

        // Funci√≥n para limpiar cach√© y recargar
        function limpiarCache() {
            try {
                console.log('üßπ Limpiando cach√© y recargando...');
                
                // Limpiar cach√© del navegador
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) {
                            caches.delete(name);
                        }
                        console.log('‚úÖ Cach√© limpiado');
                    });
                }
                
                // Forzar recarga sin cach√©
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error limpiando cach√©:', error);
                // Si falla, al menos recargar la p√°gina
                window.location.reload(true);
            }
        }

        // Funci√≥n para probar la carga de im√°genes
        async function probarCargaImagenes() {
            try {
                console.log('üñºÔ∏è PROBANDO CARGA DE IM√ÅGENES...');
                
                if (!db) {
                    console.log('‚ùå DB no est√° disponible, inicializando Firebase...');
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                
                // Obtener todos los productos
                const snapshot = await db.collection('productos').limit(6).get();
                console.log('üìä Productos encontrados para probar im√°genes:', snapshot.size);
                
                let imagenesExitosas = 0;
                let imagenesFallidas = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const nombre = data.nombre || 'Sin nombre';
                    const imagen = data.imagen;
                    
                    if (imagen && typeof imagen === 'string' && imagen.trim() !== '') {
                        console.log('üñºÔ∏è Probando imagen para:', nombre);
                        console.log('  URL:', imagen);
                        
                        // Crear una imagen de prueba
                        const img = new Image();
                        
                        img.onload = () => {
                            imagenesExitosas++;
                            console.log('  ‚úÖ IMAGEN CARGADA EXITOSAMENTE:', nombre);
                            console.log('  üìè Dimensiones:', img.naturalWidth + 'x' + img.naturalHeight);
                        };
                        
                        img.onerror = () => {
                            imagenesFallidas++;
                            console.log('  ‚ùå ERROR AL CARGAR IMAGEN:', nombre);
                            console.log('  üîó URL problem√°tica:', imagen);
                        };
                        
                        // Intentar cargar la imagen
                        img.src = imagen;
                        
                    } else {
                        console.log('‚ö†Ô∏è Producto sin imagen:', nombre);
                    }
                });
                
                // Mostrar resumen despu√©s de un tiempo
                setTimeout(() => {
                    console.log('üìä RESUMEN DE CARGA DE IM√ÅGENES:');
                    console.log(`  ‚úÖ Im√°genes exitosas: ${imagenesExitosas}`);
                    console.log(`  ‚ùå Im√°genes fallidas: ${imagenesFallidas}`);
                    console.log(`  üìä Total productos: ${snapshot.size}`);
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error probando carga de im√°genes:', error);
            }
        }

        // Funci√≥n para forzar re-renderizado de cards
        function forzarRerenderizadoCards() {
            try {
                console.log('üîÑ FORZANDO RE-RENDERIZADO DE CARDS...');
                
                const productosGrid = document.getElementById('productosGrid');
                if (!productosGrid) {
                    console.error('‚ùå No se encontr√≥ productosGrid');
                    return;
                }
                
                console.log('üîç Estado actual del grid:', {
                    display: productosGrid.style.display,
                    children: productosGrid.children.length,
                    innerHTML: productosGrid.innerHTML.length
                });
                
                // Obtener el HTML actual
                const htmlActual = productosGrid.innerHTML;
                console.log('üìù HTML actual:', htmlActual.substring(0, 300) + '...');
                
                // Forzar re-renderizado
                productosGrid.style.display = 'none';
                productosGrid.offsetHeight; // Trigger reflow
                productosGrid.style.display = 'grid';
                
                // Verificar cards despu√©s del re-renderizado
                const cards = document.querySelectorAll('.producto-card-popular');
                console.log('üéØ Cards encontradas despu√©s del re-renderizado:', cards.length);
                
                cards.forEach((card, index) => {
                    console.log(`  üì¶ Card ${index + 1}:`, {
                        visible: card.offsetParent !== null,
                        display: window.getComputedStyle(card).display,
                        nombre: card.querySelector('h3')?.textContent || 'Sin nombre'
                    });
                });
                
                // Intentar scroll para forzar renderizado
                productosGrid.scrollTop = 1;
                productosGrid.scrollTop = 0;
                
                console.log('‚úÖ Re-renderizado completado');
                
            } catch (error) {
                console.error('‚ùå Error en re-renderizado:', error);
            }
        }

        // Funci√≥n para probar la consulta de productos
        async function probarConsultaProductos() {
            try {
                console.log('üîç PROBANDO CONSULTA DE PRODUCTOS...');
                
                if (!db) {
                    console.log('‚ùå DB no est√° disponible, inicializando Firebase...');
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                
                // Probar consulta sin l√≠mite
                console.log('üìä Consultando TODOS los productos...');
                const todosLosProductos = await db.collection('productos').get();
                console.log('üìä Total productos en la base de datos:', todosLosProductos.size);
                
                // Probar consulta con l√≠mite 20
                console.log('üìä Consultando productos con l√≠mite 20...');
                const productosLimitados = await db.collection('productos').limit(20).get();
                console.log('üìä Productos con l√≠mite 20:', productosLimitados.size);
                
                // Analizar cada producto
                let productosActivos = 0;
                let productosInactivos = 0;
                let productosSinStock = 0;
                let productosConStock = 0;
                
                console.log('üîç ANALIZANDO TODOS LOS PRODUCTOS:');
                todosLosProductos.forEach(doc => {
                    const data = doc.data();
                    const nombre = data.nombre || 'Sin nombre';
                    const activo = data.activo;
                    const stock = data.stock || 0;
                    
                    console.log(`  üì¶ ${nombre}:`, {
                        activo: activo,
                        stock: stock,
                        categoria: data.categoria
                    });
                    
                    if (activo === true) {
                        productosActivos++;
                    } else {
                        productosInactivos++;
                    }
                    
                    if (stock > 0) {
                        productosConStock++;
                    } else {
                        productosSinStock++;
                    }
                });
                
                console.log('üìä RESUMEN COMPLETO:');
                console.log(`  üì¶ Total productos: ${todosLosProductos.size}`);
                console.log(`  ‚úÖ Productos activos: ${productosActivos}`);
                console.log(`  ‚ùå Productos inactivos: ${productosInactivos}`);
                console.log(`  üìà Productos con stock: ${productosConStock}`);
                console.log(`  üìâ Productos sin stock: ${productosSinStock}`);
                console.log(`  üéØ Productos que deber√≠an mostrarse: ${productosActivos} activos Y ${productosConStock} con stock`);
                
                // Calcular intersecci√≥n
                let productosValidos = 0;
                todosLosProductos.forEach(doc => {
                    const data = doc.data();
                    if (data.activo === true && (data.stock || 0) > 0) {
                        productosValidos++;
                    }
                });
                
                console.log(`  üéØ Productos v√°lidos (activos Y con stock): ${productosValidos}`);
                
            } catch (error) {
                console.error('‚ùå Error probando consulta de productos:', error);
            }
        }

        // Funci√≥n para cargar datos reales completos (categor√≠as + productos)
        async function cargarDatosRealesCompleto() {
            try {
                console.log('üîÑ Cargando datos reales completos de Firestore...');
                
                // Inicializar Firebase si no est√° disponible
                if (!db) {
                    console.log('üîÑ Inicializando Firebase...');
                    if (typeof firebase === 'undefined') {
                        console.log('‚ùå Firebase SDK no est√° disponible');
                        return;
                    }
                    
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.firestore();
                }
                
                console.log('‚úÖ Firebase disponible, cargando datos...');
                
                // Cargar categor√≠as y productos en paralelo
                await Promise.all([
                    cargarCategoriasMejorado(),
                    cargarProductosMejorado()
                ]);
                
                console.log('‚úÖ Datos reales completos cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos reales completos:', error);
            }
        }

        // Funci√≥n para cargar categor√≠as mejorada
        async function cargarCategoriasMejorado() {
            try {
                console.log('üîÑ Cargando categor√≠as mejorado...');
                mostrarLoadingCategorias(true);
                
                // Obtener todos los productos para extraer categor√≠as
                const productosSnapshot = await db.collection('productos').get();
                
                console.log('üìä Productos encontrados para categor√≠as:', productosSnapshot.size);
                
                if (productosSnapshot.empty) {
                    console.log('‚ö†Ô∏è No hay productos en la base de datos para categor√≠as');
                    mostrarCategorias([{ nombre: 'Todos los productos', count: 0, icon: 'fas fa-th-large' }]);
                    return;
                }
                
                // Extraer categor√≠as √∫nicas y contar productos
                const categoriasMap = new Map();
                let productosProcesados = 0;
                let productosActivos = 0;
                
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    const categoria = data.categoria || 'otros';
                    productosProcesados++;
                    
                    console.log(`üì¶ Producto ${productosProcesados}: ${data.nombre}`, {
                        categoria: categoria,
                        activo: data.activo,
                        stock: data.stock
                    });
                    
                    // Solo contar productos activos y con stock
                    if (data.activo === true && data.stock > 0) {
                        productosActivos++;
                        if (categoriasMap.has(categoria)) {
                            categoriasMap.set(categoria, categoriasMap.get(categoria) + 1);
                        } else {
                            categoriasMap.set(categoria, 1);
                        }
                        console.log(`‚úÖ Producto v√°lido agregado a categor√≠a: ${categoria}`);
                    } else {
                        console.log(`‚ùå Producto descartado: activo=${data.activo}, stock=${data.stock}`);
                    }
                });
                
                console.log(`üìä Resumen de productos: ${productosProcesados} procesados, ${productosActivos} activos`);
                console.log('üìä Categor√≠as encontradas:', Array.from(categoriasMap.entries()));
                
                // Contar total de productos activos y con stock
                const totalProductosActivos = Array.from(categoriasMap.values()).reduce((sum, count) => sum + count, 0);
                
                // Convertir a array y agregar "Todos los productos" solo si hay productos
                categorias = [];
                
                // Solo agregar "Todos los productos" si hay productos activos
                if (totalProductosActivos > 0) {
                    categorias.push({ 
                        nombre: 'Todos los productos', 
                        count: totalProductosActivos, 
                        icon: 'fas fa-th-large' 
                    });
                }
                
                // Agregar solo categor√≠as que tengan productos
                Array.from(categoriasMap.entries()).forEach(([nombre, count]) => {
                    if (count > 0) { // Solo agregar si tiene productos
                        categorias.push({
                            nombre: nombre.charAt(0).toUpperCase() + nombre.slice(1),
                            count: count,
                            icon: getCategoriaIcon(nombre)
                        });
                    }
                });
                
                console.log(`‚úÖ ${categorias.length} categor√≠as cargadas:`, categorias);
                mostrarCategorias(categorias);
                
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as mejorado:', error);
                mostrarErrorCategorias('Error al cargar categor√≠as. Intenta recargar la p√°gina.');
            }
        }

        // Funci√≥n para cargar productos mejorada
        async function cargarProductosMejorado() {
            try {
                console.log('üîÑ Cargando productos mejorado...');
                mostrarLoading(true);
                
                // Consulta simple sin filtros complejos - aumentar l√≠mite para obtener m√°s productos
                const productosSnapshot = await db.collection('productos').limit(20).get();
                
                console.log('üìä Productos encontrados en consulta:', productosSnapshot.size);
                
                if (productosSnapshot.empty) {
                    console.log('‚ö†Ô∏è No hay productos en la base de datos');
                    mostrarProductos([]);
                    return;
                }
                
                productos = [];
                let productosActivos = 0;
                let productosInactivos = 0;
                let productosSinStock = 0;
                
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üîç Analizando producto:', data.nombre, {
                        activo: data.activo,
                        stock: data.stock,
                        categoria: data.categoria
                    });
                    
                    // Solo incluir productos activos y con stock
                    if (data.activo === true && data.stock > 0) {
                        productosActivos++;
                        console.log('‚úÖ Producto v√°lido:', data.nombre);
                        // Verificar si la imagen es v√°lida
                        let imagenValida = null;
                        if (data.imagen && typeof data.imagen === 'string' && data.imagen.trim() !== '') {
                            // Verificar que sea una URL v√°lida
                            try {
                                new URL(data.imagen);
                                imagenValida = data.imagen;
                                console.log('‚úÖ Imagen v√°lida para', data.nombre, ':', data.imagen);
                            } catch (e) {
                                console.log('‚ùå URL de imagen inv√°lida para', data.nombre, ':', data.imagen);
                            }
                        } else {
                            console.log('‚ùå Imagen vac√≠a o nula para', data.nombre, ':', data.imagen);
                        }
                        
                        productos.push({
                            id: doc.id,
                            nombre: data.nombre || 'Sin nombre',
                            precio: data.precio || 0,
                            categoria: data.categoria || 'Sin categor√≠a',
                            stock: data.stock || 0,
                            unidad: data.unidad || 'kg',
                            imagen: imagenValida,
                            vendedor_nombre: data.vendedor_nombre || 'N/A'
                        });
                    } else {
                        if (data.activo !== true) {
                            productosInactivos++;
                            console.log('‚ùå Producto inactivo:', data.nombre, 'activo:', data.activo);
                        }
                        if (data.stock <= 0) {
                            productosSinStock++;
                            console.log('‚ùå Producto sin stock:', data.nombre, 'stock:', data.stock);
                        }
                    }
                });
                
                console.log('üìä RESUMEN DE FILTROS:');
                console.log(`  ‚úÖ Productos activos con stock: ${productosActivos}`);
                console.log(`  ‚ùå Productos inactivos: ${productosInactivos}`);
                console.log(`  ‚ùå Productos sin stock: ${productosSinStock}`);
                console.log(`  üì¶ Total productos mostrados: ${productos.length}`);
                console.log(`‚úÖ ${productos.length} productos v√°lidos encontrados:`, productos);
                mostrarProductos(productos);
                
            } catch (error) {
                console.error('‚ùå Error cargando productos mejorado:', error);
                mostrarError('Error al cargar productos. Intenta recargar la p√°gina.');
            }
        }

        // Funci√≥n para cargar datos reales de Firestore
        async function cargarDatosReales() {
            try {
                console.log('üîÑ Cargando datos reales de Firestore...');
                
                if (!db) {
                    console.log('‚ùå DB no est√° disponible, inicializando Firebase...');
                    const firebaseOk = await inicializarFirebase();
                    if (!firebaseOk) {
                        console.log('‚ùå No se pudo inicializar Firebase');
                        return;
                    }
                }
                
                console.log('‚úÖ Firebase disponible, cargando datos...');
                
                // Cargar categor√≠as y productos
                await Promise.all([
                    cargarCategorias(),
                    cargarProductos()
                ]);
                
                console.log('‚úÖ Datos reales cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos reales:', error);
            }
        }

        // Funci√≥n para mostrar datos de ejemplo como fallback
        function mostrarDatosEjemplo() {
            console.log('üìã Mostrando datos de ejemplo como fallback...');
            
            // Verificar elementos del DOM
            const categoriasGrid = document.getElementById('categoriasGrid');
            const productosGrid = document.getElementById('productosGrid');
            const loadingProducts = document.getElementById('loadingProducts');
            const emptyProducts = document.getElementById('emptyProducts');
            
            console.log('üîç Elementos en mostrarDatosEjemplo:');
            console.log('- categoriasGrid:', categoriasGrid);
            console.log('- productosGrid:', productosGrid);
            console.log('- loadingProducts:', loadingProducts);
            console.log('- emptyProducts:', emptyProducts);
            
            // NO mostrar categor√≠as de ejemplo - solo esperar datos reales
            console.log('‚ö†Ô∏è No mostrando categor√≠as de ejemplo - esperando datos reales de Firestore');
            
            // Productos de ejemplo (solo para productos, no categor√≠as)
            const productosEjemplo = [
                {
                    id: 'ejemplo1',
                    nombre: 'Manzanas Org√°nicas',
                    categoria: 'frutas',
                    precio: 25,
                    stock: 50,
                    unidad: 'kg',
                    imagen_url: null
                },
                {
                    id: 'ejemplo2',
                    nombre: 'Tomates Frescos',
                    categoria: 'verduras',
                    precio: 18,
                    stock: 30,
                    unidad: 'kg',
                    imagen_url: null
                },
                {
                    id: 'ejemplo3',
                    nombre: 'Arroz Integral',
                    categoria: 'cereales',
                    precio: 35,
                    stock: 20,
                    unidad: 'kg',
                    imagen_url: null
                },
                {
                    id: 'ejemplo4',
                    nombre: 'Lechuga Hidrop√≥nica',
                    categoria: 'verduras',
                    precio: 15,
                    stock: 25,
                    unidad: 'pieza',
                    imagen_url: null
                },
                {
                    id: 'ejemplo5',
                    nombre: 'Pl√°tanos Maduros',
                    categoria: 'frutas',
                    precio: 12,
                    stock: 40,
                    unidad: 'kg',
                    imagen_url: null
                },
                {
                    id: 'ejemplo6',
                    nombre: 'Frijoles Negros',
                    categoria: 'legumbres',
                    precio: 28,
                    stock: 15,
                    unidad: 'kg',
                    imagen_url: null
                }
            ];
            
            console.log('üìä Datos de ejemplo preparados:');
            console.log('- Categor√≠as:', categoriasEjemplo.length);
            console.log('- Productos:', productosEjemplo.length);
            
            // NO mostrar categor√≠as de ejemplo - solo productos
            console.log('‚ö†Ô∏è Categor√≠as se cargar√°n desde Firestore');
            
            // Mostrar productos de ejemplo
            console.log('üõçÔ∏è Mostrando productos de ejemplo...');
            mostrarProductos(productosEjemplo);
            
            // Mensaje de debugging removido - p√°gina limpia

            console.log('‚úÖ Datos de ejemplo mostrados correctamente');
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ DOM cargado, iniciando aplicaci√≥n...');
            // Intento inicial de actualizar el saludo (si Auth ya est√° listo)
            actualizarSaludoUsuario();
            
                // Verificar que los elementos existan antes de proceder
                const categoriasGrid = document.getElementById('categoriasGrid');
                const productosGrid = document.getElementById('productosGrid');
                const loadingProducts = document.getElementById('loadingProducts');
                const emptyProducts = document.getElementById('emptyProducts');
            
            console.log('üîç Verificando elementos del DOM:');
            console.log('- categoriasGrid:', categoriasGrid);
            console.log('- productosGrid:', productosGrid);
            console.log('- loadingProducts:', loadingProducts);
            console.log('- emptyProducts:', emptyProducts);
            
            if (!categoriasGrid || !productosGrid || !loadingProducts || !emptyProducts) {
                console.error('‚ùå Elementos del DOM no encontrados');
                return;
            }
            
            // Mostrar datos de ejemplo inmediatamente
            console.log('üìã Cargando datos de ejemplo...');
            try {
                mostrarDatosEjemplo();
                console.log('‚úÖ Datos de ejemplo cargados correctamente');
            } catch (error) {
                console.error('‚ùå Error cargando datos de ejemplo:', error);
            }
            
            // Intentar cargar datos reales inmediatamente tambi√©n
            setTimeout(async () => {
                try {
                    console.log('üîÑ Intentando cargar datos reales inmediatamente...');
                    await cargarDatosRealesCompleto();
                    console.log('‚úÖ Datos reales cargados inmediatamente');
                } catch (error) {
                    console.log('‚ö†Ô∏è No se pudieron cargar datos reales inmediatamente:', error);
                }
            }, 500); // Solo 500ms de espera
                
            // Intentar conectar a Firebase en segundo plano
            setTimeout(async () => {
                try {
                    console.log('üîÑ Intentando conectar a Firebase...');
                    const firebaseOk = await inicializarFirebase();
                    
                    if (firebaseOk) {
                        console.log('‚úÖ Firebase conectado, probando conexi√≥n con Firestore...');
                        // Vuelve a intentar actualizar el saludo cuando Auth/DB est√°n listos
                        actualizarSaludoUsuario();
                        
                        // Probar conexi√≥n con Firestore
                        const firestoreOk = await probarConexionFirestore();
                        
                        if (firestoreOk) {
                            console.log('‚úÖ Firestore conectado, cargando datos reales...');
                            
                            // Cargar datos reales usando la l√≥gica mejorada
                            try {
                                await cargarDatosRealesCompleto();
                                console.log('‚úÖ Datos reales cargados exitosamente');
                            } catch (error) {
                                console.error('‚ùå Error cargando datos reales:', error);
                            }
                            
                            // Mostrar mensaje de actualizaci√≥n
                            const mensajeActualizacion = document.createElement('div');
                            mensajeActualizacion.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #4CAF50;
                                color: white;
                                padding: 15px 20px;
                                border-radius: 8px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                z-index: 1000;
                                font-size: 14px;
                            `;
                            mensajeActualizacion.innerHTML = `
                                <i class="fas fa-check-circle"></i>
                                <span style="margin-left: 8px;">Datos actualizados desde Firebase</span>
                            `;
                            
                            document.body.appendChild(mensajeActualizacion);
                            
                            // Remover despu√©s de 3 segundos
                            setTimeout(() => {
                                if (mensajeActualizacion.parentNode) {
                                    mensajeActualizacion.parentNode.removeChild(mensajeActualizacion);
                                }
                            }, 3000);
                            
                        } else {
                            console.log('‚ö†Ô∏è Firestore no disponible, manteniendo datos de ejemplo');
                        }
                        
                    } else {
                        console.log('‚ö†Ô∏è Firebase no disponible, manteniendo datos de ejemplo');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error conectando a Firebase:', error);
                    console.log('‚ö†Ô∏è Manteniendo datos de ejemplo');
                }
            }, 1000); // Esperar 1 segundo antes de intentar conectar
            
            // Funcionalidad b√°sica de filtros
            const filterButtons = document.querySelectorAll('.filter-btn');
            const filtersContainer = document.querySelector('.filters-container');
            
            // Toggle de filtros
            filterButtons.forEach(btn => {
                if (btn.textContent === 'Filtrar') {
                    btn.addEventListener('click', function() {
                        filtersContainer.style.display = filtersContainer.style.display === 'none' ? 'block' : 'none';
                    });
                }
            });
            
            // Botones de ordenamiento
            const sortButtons = document.querySelectorAll('.sort-btn');
            sortButtons.forEach(btn => {
                if (btn.textContent === 'Ordenar') {
                    btn.addEventListener('click', function() {
                        alert('Funci√≥n de ordenamiento pr√≥ximamente');
                    });
                }
            });
        });
    </script>
</body>
</html>
