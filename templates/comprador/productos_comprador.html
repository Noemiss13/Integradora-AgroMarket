<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ categoria if categoria else "Productos" }} - AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/breadcrumbs.css') }}">
</head>
<body>
    <!-- ===== Men√∫ superior ===== -->
    <nav>
        <div class="nav-left">
            <div class="logo">
                <h2>AgroMarket</h2>
            </div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="{{ url_for('comprador.panel_comprador') }}" class="{% if page=='inicio' %}activo{% endif %}">Inicio</a>
            <a href="{{ url_for('comprador.ver_productos') }}" class="{% if page=='productos' %}activo{% endif %}">Productos</a>
            <a href="{{ url_for('comprador.ver_carrito') }}" class="{% if page=='carrito' %}activo{% endif %}">Carrito</a>
            <a href="{{ url_for('auth.perfil') }}">Mi Perfil</a>
            <a href="{{ url_for('auth.logout') }}">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <main class="productos-main">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs" id="breadcrumbs-container">
            <a href="/comprador/panel">Inicio</a>
            <span>/</span>
            <a href="/comprador/productos">Productos</a>
            <span id="breadcrumb-categoria-separator" style="display: none;">/</span>
            <span id="breadcrumb-categoria" style="display: none;"></span>
        </div>

        <!-- ===== Header de la categor√≠a ===== -->
        <header class="categoria-header">
            <div class="categoria-info">
                <h1 id="categoria-titulo">{{ categoria if categoria else "Todos los productos" }}</h1>
                <p class="producto-count" id="producto-count">Cargando productos...</p>
            </div>
            <div class="categoria-controls">
                <input type="text" placeholder="Buscar en productos..." class="search-input">
                <button class="control-btn">Ordenar por</button>
                <button class="control-btn">Precio</button>
                <button class="control-btn">Ubicaci√≥n</button>
            </div>
        </header>

        <div class="productos-layout">
            <!-- ===== Sidebar de filtros ===== -->
            <aside class="filters-sidebar">
                <h3>Filtros</h3>
                
                <div class="filter-group">
                    <h4>Disponibilidad</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active">En stock</button>
                        <button class="filter-btn">Pre-orden</button>
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Tipo</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active">Org√°nico</button>
                        <button class="filter-btn">Convencional</button>
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Presentaci√≥n</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active">Kg</button>
                        <button class="filter-btn">Caja</button>
                        <button class="filter-btn">Bulto</button>
                    </div>
                </div>
            </aside>

            <!-- ===== Grid de productos ===== -->
            <section class="productos-section">
                <div class="productos-grid-new">
                    <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
                </div>
                
                <div class="no-products" style="display: none;">
                    <div class="no-products-content">
                        <i class="fas fa-search"></i>
                        <h3>No hay productos disponibles</h3>
                        <p>No se encontraron productos en esta categor√≠a.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- ===== Scripts ===== -->
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- Firebase Config -->
    <script src="/static/js/firebase-config.js"></script>
    
    <script>
        // Variables globales
        let db;
        let productos = [];
        const categoriaActual = '{{ categoria }}';
        
        // Normalizar nombre de categor√≠a para comparaci√≥n
        function normalizarCategoria(cat) {
            if (!cat || cat === '') return null;
            // Convertir a lowercase, reemplazar guiones con espacios, y normalizar espacios m√∫ltiples
            return cat.toLowerCase()
                .replace(/-/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Obtener nombre legible de categor√≠a
        function obtenerNombreCategoria(cat) {
            if (!cat || cat === '') return 'Todos los productos';
            // Capitalizar primera letra de cada palabra
            return cat.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        // Actualizar breadcrumb con la categor√≠a actual
        function actualizarBreadcrumb(categoriaFiltro) {
            const breadcrumbCategoria = document.getElementById('breadcrumb-categoria');
            const breadcrumbSeparator = document.getElementById('breadcrumb-categoria-separator');
            
            if (!breadcrumbCategoria || !breadcrumbSeparator) return;
            
            // Si hay una categor√≠a espec√≠fica, mostrarla en el breadcrumb
            if (categoriaFiltro && categoriaFiltro !== 'todos los productos') {
                breadcrumbCategoria.textContent = obtenerNombreCategoria(categoriaFiltro);
                breadcrumbCategoria.style.display = 'inline';
                breadcrumbSeparator.style.display = 'inline';
            } else {
                breadcrumbCategoria.style.display = 'none';
                breadcrumbSeparator.style.display = 'none';
            }
        }
        
        
        // Inicializar Firebase
        async function inicializarFirebase() {
            try {
                console.log('üîÑ Inicializando Firebase...');
                
                // Esperar a que Firebase est√© disponible
                let intentos = 0;
                const maxIntentos = 20;
                
                while (typeof firebase === 'undefined' && intentos < maxIntentos) {
                    console.log(`‚è≥ Esperando Firebase... (intento ${intentos + 1}/${maxIntentos})`);
                    await new Promise(resolve => setTimeout(resolve, 250));
                    intentos++;
                }
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no se carg√≥ despu√©s de 5 segundos');
                }
                
                console.log('‚úÖ Firebase SDK disponible');
                
                // Verificar que la configuraci√≥n est√© disponible
                if (!window.firebaseConfig) {
                    throw new Error('Configuraci√≥n de Firebase no disponible');
                }
                
                console.log('‚úÖ Configuraci√≥n de Firebase disponible');
                
                // Inicializar Firebase si no est√° inicializado
                if (firebase.apps.length === 0) {
                    console.log('üîÑ Inicializando nueva instancia de Firebase...');
                    firebase.initializeApp(window.firebaseConfig);
                    console.log('‚úÖ Firebase inicializado');
                } else {
                    console.log('‚úÖ Firebase ya estaba inicializado');
                }
                
                db = firebase.firestore();
                
                // Configuraciones de rendimiento
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true
                });
                
                console.log('‚úÖ Firebase configurado correctamente');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                return false;
            }
        }
        
        // Cargar todos los productos (filtrados por categor√≠a si existe)
        async function cargarTodosLosProductos() {
            try {
                if (!db) {
                    throw new Error('Base de datos de Firestore no est√° disponible');
                }
                
                // Normalizar categor√≠a actual para filtrar
                const categoriaFiltro = normalizarCategoria(categoriaActual);
                console.log('üîç Categor√≠a a filtrar:', categoriaFiltro);
                
                // Actualizar t√≠tulo de la p√°gina
                const categoriaTitulo = document.getElementById('categoria-titulo');
                if (categoriaTitulo) {
                    categoriaTitulo.textContent = obtenerNombreCategoria(categoriaActual);
                }
                
                // Actualizar breadcrumb
                actualizarBreadcrumb(categoriaFiltro);
                
                const productosSnapshot = await db.collection('productos').get();
                
                if (productosSnapshot.empty) {
                    mostrarProductos([]);
                    return;
                }
                
                productos = [];
                
                productosSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Solo incluir productos activos y con stock
                    if (data.activo !== true || (data.stock || 0) <= 0) {
                        return;
                    }
                    
                    // Normalizar categor√≠a del producto
                    const categoriaProducto = normalizarCategoria(data.categoria || 'otros');
                    
                    // Filtrar por categor√≠a si se especific√≥ una
                    if (categoriaFiltro && categoriaFiltro !== 'todos los productos') {
                        if (categoriaProducto !== categoriaFiltro) {
                            return; // Saltar este producto si no coincide
                        }
                    }
                    
                    // Verificar si la imagen es v√°lida
                    let imagenValida = null;
                    if (data.imagen && typeof data.imagen === 'string' && data.imagen.trim() !== '') {
                        try {
                            new URL(data.imagen);
                            imagenValida = data.imagen;
                        } catch (e) {
                            // Imagen inv√°lida, usar placeholder
                        }
                    }
                    
                    productos.push({
                        id: doc.id,
                        nombre: data.nombre || 'Sin nombre',
                        precio: data.precio || 0,
                        categoria: data.categoria || 'otros',
                        stock: data.stock || 0,
                        unidad: data.unidad || 'kg',
                        imagen: imagenValida,
                        vendedor_nombre: data.vendedor_nombre || 'N/A',
                        descripcion: data.descripcion || '',
                        origen: data.origen || 'Local',
                        activo: data.activo || false
                    });
                });
                
                console.log(`‚úÖ ${productos.length} productos cargados para categor√≠a: ${categoriaFiltro || 'Todas'}`);
                mostrarProductos(productos);
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                mostrarError('Error al cargar productos. Intenta recargar la p√°gina.');
            }
        }
        
        // Mostrar productos en el grid con cards peque√±as
        function mostrarProductos(productosParaMostrar) {
            try {
                const productosGrid = document.querySelector('.productos-grid-new');
                const noProducts = document.querySelector('.no-products');
            
                if (!productosParaMostrar || productosParaMostrar.length === 0) {
                    if (productosGrid) productosGrid.style.display = 'none';
                    if (noProducts) noProducts.style.display = 'block';
                    return;
                }
                
                // Mostrar productos
                if (noProducts) noProducts.style.display = 'none';
                if (productosGrid) productosGrid.style.display = 'grid';
            
            const productosHTML = productosParaMostrar.map(producto => {
                return `
                    <article class="producto-card-small" 
                         data-id="${producto.id}" 
                         data-nombre="${producto.nombre}" 
                         data-precio="${producto.precio}"
                         data-categoria="${producto.categoria}"
                         data-stock="${producto.stock}">
                    
                        <a href="/comprador/detalle_producto/${producto.id}" class="producto-link-small" style="text-decoration: none; color: inherit;">
                            <div class="producto-image-small">
                            ${producto.imagen && producto.imagen.trim() !== '' ? 
                                    `<img src="${producto.imagen}" alt="${producto.nombre}" class="producto-img-small" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                     <div class="producto-placeholder-small" style="display: none;">
                                     <i class="fas fa-box"></i>
                                 </div>` :
                                    `<div class="producto-placeholder-small">
                                     <i class="fas fa-box"></i>
                                 </div>`
                            }
                            </div>
                            
                            <div class="producto-info-small">
                                <h4 class="producto-nombre-small">${producto.nombre}</h4>
                            
                                <div class="producto-precio-small">
                                $${producto.precio.toFixed(2)} / ${producto.unidad}
                            </div>
                            
                                <div class="producto-stock-small">
                                    <span class="stock-label">Stock:</span>
                                    <span class="stock-value">${producto.stock} ${producto.unidad}</span>
                            </div>
                            </a>
                            
                            <div class="producto-controls-small" onclick="event.stopPropagation();">
                                <div class="cantidad-controls">
                                    <button class="cantidad-btn menos" onclick="cambiarCantidad('${producto.id}', -1)">-</button>
                                    <input type="number" class="cantidad-input" id="cantidad-${producto.id}" value="1" min="1" max="${producto.stock}">
                                    <button class="cantidad-btn mas" onclick="cambiarCantidad('${producto.id}', 1)">+</button>
                                </div>
                                
                                <button class="agregar-carrito-btn" onclick="agregarAlCarrito('${producto.id}')">
                                    <i class="fas fa-cart-plus"></i>
                                    Agregar
                                </button>
                            </div>
                </article>
                `;
            }).join('');
            
            productosGrid.innerHTML = productosHTML;
            
            // Actualizar contador de productos
            const productoCount = document.getElementById('producto-count');
            if (productoCount) {
                productoCount.textContent = `${productosParaMostrar.length} productos ‚Ä¢ Disponibles`;
            }
                
                // Actualizar estado de botones de cantidad
                setTimeout(() => {
                    actualizarTodosLosBotones();
                }, 100);
            
            } catch (error) {
                console.error('Error en mostrarProductos:', error);
            }
        }
        
        // Mostrar error
        function mostrarError(mensaje) {
            const productosGrid = document.querySelector('.productos-grid-new');
            const noProducts = document.querySelector('.no-products');
            
            if (productosGrid) productosGrid.style.display = 'none';
            if (noProducts) {
                noProducts.innerHTML = `<p>${mensaje}</p>`;
                noProducts.style.display = 'block';
            }
        }
        
        // Funci√≥n para verificar autenticaci√≥n
        function verificarAutenticacion() {
            const user = firebase.auth().currentUser;
            if (user) {
                console.log('‚úÖ Usuario autenticado:', user.email);
                return true;
            } else {
                console.log('‚ùå Usuario no autenticado');
                return false;
            }
        }
        
        // Funci√≥n para mostrar estado de autenticaci√≥n
        function mostrarEstadoAutenticacion() {
            const user = firebase.auth().currentUser;
            const navSaludo = document.querySelector('.saludo-usuario');
            
            if (user && navSaludo) {
                navSaludo.innerHTML = `Hola, <strong>${user.email || 'Usuario'}</strong>`;
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Iniciando carga de p√°gina...');
                
                const firebaseInicializado = await inicializarFirebase();
                
                if (firebaseInicializado) {
                    console.log('‚úÖ Firebase inicializado correctamente');
                    
                    // Verificar autenticaci√≥n
                    verificarAutenticacion();
                    mostrarEstadoAutenticacion();
                    
                    // Escuchar cambios en autenticaci√≥n
                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            console.log('üë§ Usuario logueado:', user.email);
                            mostrarEstadoAutenticacion();
                        } else {
                            console.log('üë§ Usuario deslogueado');
                            const navSaludo = document.querySelector('.saludo-usuario');
                            if (navSaludo) {
                                navSaludo.innerHTML = 'Hola, <strong>Usuario</strong>';
                            }
                        }
                    });
                    
                    // Cargar productos
                    await cargarTodosLosProductos();
                    
                    console.log('‚úÖ P√°gina cargada completamente');
                } else {
                    mostrarError('No se pudo conectar con la base de datos. Intenta recargar la p√°gina.');
                }
            } catch (error) {
                console.error('‚ùå Error cargando productos:', error);
                mostrarError('Error al cargar productos. Intenta recargar la p√°gina.');
            }
        });
        
        // B√∫squeda en tiempo real
        document.querySelector('.search-input').addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            if (query === '') {
                mostrarProductos(productos);
                return;
            }
            
            const productosFiltrados = productos.filter(producto => 
                producto.nombre.toLowerCase().includes(query) ||
                producto.categoria.toLowerCase().includes(query) ||
                producto.vendedor_nombre.toLowerCase().includes(query)
            );
            
            mostrarProductos(productosFiltrados);
        });

        // Filtros de sidebar
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remover active de todos los botones del mismo grupo
                const group = this.closest('.filter-group');
                group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                
                // Agregar active al bot√≥n clickeado
                this.classList.add('active');
                
                console.log('Filtro seleccionado:', this.textContent);
            });
        });

        // Botones de control
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Control clickeado:', this.textContent);
            });
        });

        // Funci√≥n para cambiar cantidad
        function cambiarCantidad(productoId, cambio) {
            const input = document.getElementById(`cantidad-${productoId}`);
            const producto = productos.find(p => p.id === productoId);
            
            if (!producto) return;
            
            let nuevaCantidad = parseInt(input.value) + cambio;
            
            // Validar l√≠mites
            if (nuevaCantidad < 1) nuevaCantidad = 1;
            if (nuevaCantidad > producto.stock) nuevaCantidad = producto.stock;
            
            input.value = nuevaCantidad;
            
            // Actualizar estado de botones
            actualizarBotonesCantidad(productoId);
        }
        
        // Funci√≥n para actualizar estado de botones de cantidad
        function actualizarBotonesCantidad(productoId) {
            const input = document.getElementById(`cantidad-${productoId}`);
            const producto = productos.find(p => p.id === productoId);
            
            if (!producto) return;
            
            const cantidad = parseInt(input.value);
            const card = input.closest('.producto-card-small');
            const btnMenos = card.querySelector('.cantidad-btn.menos');
            const btnMas = card.querySelector('.cantidad-btn.mas');
            
            // Deshabilitar botones seg√∫n l√≠mites
            btnMenos.disabled = cantidad <= 1;
            btnMas.disabled = cantidad >= producto.stock;
        }
        
        // Funci√≥n para agregar al carrito
        async function agregarAlCarrito(productoId) {
            try {
                console.log('üõí Iniciando proceso de agregar al carrito...');
                
                // Verificar que Firebase est√© inicializado
                if (!db) {
                    throw new Error('Base de datos no est√° disponible');
                }
                
                const producto = productos.find(p => p.id === productoId);
                if (!producto) {
                    console.error('‚ùå Producto no encontrado:', productoId);
                    mostrarNotificacion('‚ùå Producto no encontrado');
                    return;
                }
                
                const cantidad = parseInt(document.getElementById(`cantidad-${productoId}`).value);
                console.log('üì¶ Cantidad seleccionada:', cantidad);
                
                if (cantidad < 1 || cantidad > producto.stock) {
                    mostrarNotificacion('‚ùå Cantidad inv√°lida. Verifica el stock disponible.');
                    return;
                }
                
                // Obtener usuario actual
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('‚ùå Usuario no autenticado');
                    mostrarNotificacion('‚ùå Debes estar logueado para agregar productos al carrito');
                    return;
                }
                
                console.log('üë§ Usuario autenticado:', user.uid);
                
                // Verificar si el producto ya est√° en el carrito
                const carritoSnapshot = await db.collection('carrito')
                    .where('usuario_id', '==', user.uid)
                    .where('producto_id', '==', productoId)
                    .get();
                
                if (!carritoSnapshot.empty) {
                    // Si ya existe, actualizar la cantidad
                    const itemExistente = carritoSnapshot.docs[0];
                    const nuevaCantidad = itemExistente.data().cantidad + cantidad;
                    
                    if (nuevaCantidad > producto.stock) {
                        mostrarNotificacion('‚ùå No hay suficiente stock disponible');
                        return;
                    }
                    
                    await db.collection('carrito').doc(itemExistente.id).update({
                        cantidad: nuevaCantidad,
                        fecha_agregado: new Date().toISOString()
                    });
                    
                    mostrarNotificacion(`‚úÖ ${cantidad} ${producto.unidad} m√°s de ${producto.nombre} agregado al carrito`);
                } else {
                    // Si no existe, crear nuevo item
                    const itemCarrito = {
                        producto_id: productoId,
                        nombre: producto.nombre,
                        precio: producto.precio,
                        cantidad: cantidad,
                        unidad: producto.unidad,
                        imagen: producto.imagen,
                        vendedor_nombre: producto.vendedor_nombre,
                        fecha_agregado: new Date().toISOString(),
                        usuario_id: user.uid,
                        categoria: producto.categoria,
                        origen: producto.origen
                    };
                    
                    console.log('üìù Agregando nuevo item al carrito:', itemCarrito);
                    await db.collection('carrito').add(itemCarrito);
                    
                    mostrarNotificacion(`‚úÖ ${cantidad} ${producto.unidad} de ${producto.nombre} agregado al carrito`);
                }
                
                // Resetear cantidad a 1
                document.getElementById(`cantidad-${productoId}`).value = 1;
                actualizarBotonesCantidad(productoId);
                
                console.log('‚úÖ Producto agregado al carrito exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error agregando al carrito:', error);
                console.error('‚ùå Detalles del error:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                let mensajeError = '‚ùå Error al agregar al carrito. Intenta nuevamente.';
                
                if (error.code === 'permission-denied') {
                    mensajeError = '‚ùå No tienes permisos para agregar al carrito';
                } else if (error.code === 'unavailable') {
                    mensajeError = '‚ùå Servicio no disponible. Verifica tu conexi√≥n';
                }
                
                mostrarNotificacion(mensajeError);
            }
        }
        
        // Funci√≥n para mostrar notificaciones
        function mostrarNotificacion(mensaje) {
            // Crear elemento de notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion-carrito';
            notificacion.textContent = mensaje;
            
            // Agregar estilos
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--green);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: var(--shadow);
                z-index: 1000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            
            // Agregar animaci√≥n CSS
            if (!document.querySelector('#notificacion-styles')) {
                const style = document.createElement('style');
                style.id = 'notificacion-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notificacion);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notificacion.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }
        
        // Actualizar botones cuando se carga la p√°gina
        function actualizarTodosLosBotones() {
            productos.forEach(producto => {
                actualizarBotonesCantidad(producto.id);
            });
        }

    </script>
</body>
</html>
