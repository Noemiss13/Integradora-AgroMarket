<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ categoria if categoria else "Productos" }} - AgroMarket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_comprador.css') }}">
</head>
<body>
    <!-- ===== Men√∫ superior ===== -->
    <nav>
        <div class="nav-left">
            <div class="logo">
                <h2>AgroMarket</h2>
            </div>
            <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
        </div>
        <div class="menu">
            <a href="{{ url_for('comprador.panel_comprador') }}" class="{% if page=='inicio' %}activo{% endif %}">Inicio</a>
            <a href="{{ url_for('comprador.ver_productos') }}" class="{% if page=='productos' %}activo{% endif %}">Productos</a>
            <a href="{{ url_for('comprador.ver_carrito') }}" class="{% if page=='carrito' %}activo{% endif %}">Carrito</a>
            <a href="{{ url_for('auth.perfil') }}">Mi Perfil</a>
            <a href="{{ url_for('auth.logout') }}">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <main class="productos-main">
        <!-- ===== Header de la categor√≠a ===== -->
        <header class="categoria-header">
            <div class="categoria-info">
                <h1>{{ categoria|title if categoria else "Todos los productos" }}</h1>
                <p class="producto-count">{{ productos|length }} productos ‚Ä¢ {{ categoria_tag if categoria_tag else "Disponibles" }}</p>
            </div>
            <div class="categoria-controls">
                <input type="text" placeholder="Buscar en {{ categoria|title if categoria else 'productos' }}..." class="search-input">
                <button class="control-btn">Ordenar por</button>
                <button class="control-btn">Precio</button>
                <button class="control-btn">Ubicaci√≥n</button>
            </div>
        </header>

        <div class="productos-layout">
            <!-- ===== Sidebar de filtros ===== -->
            <aside class="filters-sidebar">
                <h3>Filtros</h3>
                
                <div class="filter-group">
                    <h4>Disponibilidad</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active">En stock</button>
                        <button class="filter-btn">Pre-orden</button>
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Tipo</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active">Org√°nico</button>
                        <button class="filter-btn">Convencional</button>
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Presentaci√≥n</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active">Kg</button>
                        <button class="filter-btn">Caja</button>
                        <button class="filter-btn">Bulto</button>
                    </div>
                </div>
            </aside>

            <!-- ===== Grid de productos ===== -->
            <section class="productos-section">
                {% if productos %}
                    <div class="productos-grid-new">
                        {% for p in productos %}
                        <article class="producto-card-new" 
                                 data-id="{{ p.id }}" 
                                 data-nombre="{{ p.nombre }}" 
                                 data-precio="{{ p.precio }}"
                                 data-categoria="{{ p.categoria|lower }}"
                                 data-stock="{{ p.stock }}">
                            
                            <div class="producto-image">
                                <img src="{{ url_for('static', filename='uploads/' + p.imagen) if p.imagen else url_for('static', filename='images/default-product.png') }}" alt="{{ p.nombre }}">
                            </div>
                            
                            <div class="producto-info">
                                <h3>{{ p.nombre }}</h3>
                                
                                <div class="producto-tags">
                                    <span class="producto-tag">{{ p.tag if p.tag else 'Disponible' }}</span>
                                </div>
                                
                                <div class="producto-origin">
                                    <span>Origen: {{ p.origen if p.origen else 'Local' }}</span>
                                </div>
                                
                                <div class="producto-price">
                                    ${{ "%.2f"|format(p.precio|float) }} / {{ p.unidad if p.unidad else 'kg' }}
                                </div>
                                
                                <div class="producto-stock">
                                    <span class="stock-icon">üì¶</span>
                                    <span>{{ p.stock }} {{ p.unidad if p.unidad else 'kg' }}</span>
                                </div>
                                
                                <!-- Bot√≥n agregar al carrito -->
                                <form action="{{ url_for('comprador.agregar_carrito', producto_id=p.id) }}" method="POST" class="form-agregar-carrito">
                                    <div class="cantidad-controls">
                                        <button type="button" class="btn-cantidad disminuir" title="Disminuir cantidad">-</button>
                                        <input type="number" name="cantidad" min="1" max="{{ p.stock }}" value="1" class="cantidad-input" title="Cantidad a agregar al carrito" readonly>
                                        <button type="button" class="btn-cantidad aumentar" title="Aumentar cantidad">+</button>
                                    </div>
                                    <button type="submit" class="btn-agregar-carrito">
                                        Agregar al carrito
                                    </button>
                                </form>
                            </div>
                        </article>
                        {% endfor %}
                    </div>
                    
                    <!-- ===== Paginaci√≥n ===== -->
                    <div class="pagination">
                        <div class="pagination-info">
                            Mostrando 1-{{ productos|length }} de {{ productos|length }} {{ categoria if categoria else 'productos' }}
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn prev" disabled>Anterior</button>
                            <button class="pagination-btn next">Siguiente</button>
                        </div>
                    </div>
                {% else %}
                    <div class="no-products">
                        <p>No hay productos disponibles en esta categor√≠a.</p>
                    </div>
                {% endif %}
            </section>
        </div>
    </main>

    <!-- ===== Scripts ===== -->
    <script>
        // B√∫squeda en tiempo real
        document.querySelector('.search-input').addEventListener('input', function() {
            const query = this.value.trim();
            // Aqu√≠ se puede implementar b√∫squeda en tiempo real
            console.log('Buscando:', query);
        });

        // Filtros de sidebar
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remover active de todos los botones del mismo grupo
                const group = this.closest('.filter-group');
                group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                
                // Agregar active al bot√≥n clickeado
                this.classList.add('active');
                
                // Aqu√≠ se puede implementar el filtrado
                console.log('Filtro seleccionado:', this.textContent);
            });
        });

        // Botones de control
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Control clickeado:', this.textContent);
                // Aqu√≠ se puede implementar ordenamiento
            });
        });

        // Paginaci√≥n
        document.querySelector('.pagination-btn.next').addEventListener('click', function() {
            console.log('Siguiente p√°gina');
            // Aqu√≠ se puede implementar paginaci√≥n
        });

        document.querySelector('.pagination-btn.prev').addEventListener('click', function() {
            console.log('P√°gina anterior');
            // Aqu√≠ se puede implementar paginaci√≥n
        });

        // Control de cantidad en formularios
        document.querySelectorAll('.form-agregar-carrito').forEach(form => {
            const input = form.querySelector('.cantidad-input');
            const btnMenos = form.querySelector('.disminuir');
            const btnMas = form.querySelector('.aumentar');
            const stock = parseInt(form.closest('.producto-card-new').dataset.stock);

            btnMas.addEventListener('click', () => {
                let val = parseInt(input.value);
                if (val < stock) input.value = val + 1;
            });

            btnMenos.addEventListener('click', () => {
                let val = parseInt(input.value);
                if (val > 1) input.value = val - 1;
            });
        });

        // Mejorar experiencia del usuario al agregar al carrito
        document.querySelectorAll('.form-agregar-carrito').forEach(form => {
            form.addEventListener('submit', function(e) {
                const button = form.querySelector('.btn-agregar-carrito');
                const originalText = button.textContent;
                
                // Deshabilitar bot√≥n y cambiar texto
                button.disabled = true;
                button.textContent = 'Agregando...';
                
                // Rehabilitar despu√©s de 3 segundos (en caso de error de red)
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 3000);
            });
        });
    </script>
</body>
</html>
