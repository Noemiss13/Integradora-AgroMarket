<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Producto - AgroMarket</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_vendedor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/formulario_productos.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- PWA: Manifest y theme color -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2e8b57">

    <!-- Iconos -->
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icons/icons-192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='images/icons/icons-512.png') }}">
</head>
<body>
<nav>
    <div class="nav-left">
        <div class="logo"><h2>AgroMarket</h2></div>
        <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
    </div>
    <div class="menu">
        <a href="{{ url_for('vendedor.panel_vendedor') }}">Home</a>
        <a href="{{ url_for('vendedor.agregar_producto') }}" class="activo">Agregar Productos</a>
        <a href="{{ url_for('vendedor.productos') }}">Mis Productos</a>
        <a href="{{ url_for('vendedor.ventas') }}">Ventas</a>
        <a href="{{ url_for('auth.perfil') }}">Mi Perfil</a>
        <a href="{{ url_for('auth.logout') }}">Cerrar Sesión</a>
    </div>
</nav>

<main>
    <h1>Agregar Producto</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="product-form-container">
        <div class="form-column">
            <form action="{{ url_for('vendedor.agregar_producto') }}" method="POST" enctype="multipart/form-data" id="productForm">
                <div class="form-group">
                    <label for="nombre">Nombre del producto:</label>
                    <input type="text" id="nombre" name="nombre" placeholder="Ej: Manzanas rojas" required>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripción:</label>
                    <textarea id="descripcion" name="descripcion" placeholder="Describe tu producto, origen, características especiales, etc." required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="categoria">Categoría:</label>
                        <select id="categoria" name="categoria" required>
                            <option value="">--Selecciona una--</option>
                            <option value="frutas">Frutas</option>
                            <option value="verduras">Verduras</option>
                            <option value="semillas">Semillas</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="unidad">Unidad mínima:</label>
                        <select id="unidad" name="unidad" required>
                            <option value="kg">kg</option>
                            <option value="reja">Reja</option>
                            <option value="tonelada">Tonelada</option>
                        </select>
                        <div id="unidad-mensaje" class="unidad-mensaje" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>Mínimo 5 kg por unidad</span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio">Precio (MXN):</label>
                        <input type="number" id="precio" name="precio" min="0" step="0.01" placeholder="25.50" required>
                    </div>
                    <div class="form-group">
                        <label for="stock">Cantidad disponible:</label>
                        <input type="number" id="stock" name="stock" min="1" step="1" placeholder="100" required>
                        <div id="stock-mensaje" class="stock-mensaje" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>Mínimo 5 unidades</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Imagen del producto:</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="imagen" name="imagen" accept="image/*" class="file-input" aria-label="Seleccionar imagen del producto" required>
                        <div class="file-upload-content">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="file-upload-text">Haz clic para subir una imagen</div>
                            <div class="file-upload-subtext">o arrastra y suelta una imagen aquí</div>
                        </div>
                    </div>
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImg" src="" alt="Vista previa de la imagen">
                        <button type="button" id="removeImage" class="remove-image-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-upload"></i> Publicar Producto
                </button>
            </form>
        </div>
    </div>
</main>

<!-- Service Worker -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("{{ url_for('static', filename='js/service-worker.js') }}")
    .then(reg => console.log("✅ Service Worker registrado:", reg))
    .catch(err => console.error("❌ Error al registrar SW:", err));
  }
</script>

<!-- IndexedDB y sincronización offline -->
<script>
let db;
const request = indexedDB.open("AgroMarketDB", 1);

request.onerror = () => console.error("❌ Error abriendo IndexedDB");
request.onsuccess = () => { 
  db = request.result; 
  console.log("✅ IndexedDB lista");
  syncPendingProducts();
};

request.onupgradeneeded = (e) => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("productos")) {
    db.createObjectStore("productos", { keyPath: "id", autoIncrement: true });
  }
};

const form = document.getElementById("productForm");
form.addEventListener("submit", (e) => {
  e.preventDefault();

  const formData = new FormData(form);
  const producto = {
    nombre: formData.get("nombre"),
    descripcion: formData.get("descripcion"),
    categoria: formData.get("categoria"),
    unidad: formData.get("unidad"),
    precio: formData.get("precio"),
    stock: formData.get("stock"),
    imagen: null
  };

  const file = formData.get("imagen");
  const reader = new FileReader();
  reader.onload = () => {
    producto.imagen = reader.result;

    if (navigator.onLine) {
      enviarProducto(producto);
    } else {
      guardarOffline(producto);
      alert("⚠️ Producto guardado offline. Se enviará cuando tengas internet.");
      form.reset();
    }
  };
  if (file) reader.readAsDataURL(file);
});

function guardarOffline(producto) {
  const tx = db.transaction("productos", "readwrite");
  const store = tx.objectStore("productos");
  store.add(producto);
}

function syncPendingProducts() {
  if (!navigator.onLine) return;

  const tx = db.transaction("productos", "readonly");
  const store = tx.objectStore("productos");
  const getAll = store.getAll();

  getAll.onsuccess = async () => {
    const productos = getAll.result;
    for (const p of productos) {
      await enviarProducto(p);
      const delTx = db.transaction("productos", "readwrite");
      delTx.objectStore("productos").delete(p.id);
    }
  };
}

window.addEventListener("online", syncPendingProducts);

async function enviarProducto(producto) {
  try {
    const formData = new FormData();
    for (const key in producto) {
      if (key === "imagen") {
        const blob = await (await fetch(producto.imagen)).blob();
        formData.append("imagen", blob, "producto.jpg");
      } else {
        formData.append(key, producto[key]);
      }
    }
    const res = await fetch("/vendedor/agregar_producto", {
      method: "POST",
      body: formData
    });
    if (res.ok) console.log("✅ Producto enviado:", producto.nombre);
  } catch (err) {
    console.error("❌ Error enviando producto:", err);
  }
}
</script>

<style>
  .offline-disabled {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

</body>
</html>
