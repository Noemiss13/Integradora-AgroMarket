<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Producto - AgroMarket</title>
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/estilos_vendedor.css">
    <link rel="stylesheet" href="/static/css/formulario_productos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<nav>
    <div class="nav-left">
        <div class="logo"><h2>AgroMarket</h2></div>
        <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
    </div>
    <div class="menu">
        <a href="/vendedor/panel">Home</a>
        <a href="/vendedor/agregar_producto" class="activo">Agregar Productos</a>
        <a href="/vendedor/mis_productos">Mis Productos</a>
        <a href="#" onclick="alert('Funci√≥n pr√≥ximamente')">Ventas</a>
        <a href="/auth/perfil">Mi Perfil</a>
        <a href="#" onclick="cerrarSesion()">Cerrar Sesi√≥n</a>
    </div>
</nav>

<main>
    <h1>Agregar Producto</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="product-form-container">
        <form id="productForm" class="form-two-columns">
            <!-- Columna izquierda: Campos del formulario -->
            <div class="form-left-column">
                <div class="form-group">
                    <label for="nombre">Nombre del producto:</label>
                    <input type="text" id="nombre" name="nombre" placeholder="Ej: Manzanas rojas" required maxlength="100">
                    <div id="nombre-error" class="field-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="nombre-error-texto"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripci√≥n:</label>
                    <textarea id="descripcion" name="descripcion" placeholder="Describe tu producto, origen, caracter√≠sticas especiales, etc." required maxlength="1000"></textarea>
                    <div id="descripcion-error" class="field-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="descripcion-error-texto"></span>
                    </div>
                    <small class="char-counter">
                        <span id="descripcion-counter">0</span>/1000 caracteres
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="categoria">Categor√≠a:</label>
                        <select id="categoria" name="categoria" required>
                            <option value="">--Selecciona una--</option>
                            <option value="frutas">Frutas</option>
                            <option value="verduras">Verduras</option>
                            <option value="semillas">Semillas</option>
                            <option value="otros">Otros</option>
                        </select>
                        <div id="categoria-error" class="field-error" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Debes seleccionar una categor√≠a</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="unidad">Unidad m√≠nima:</label>
                        <select id="unidad" name="unidad" required>
                            <option value="">--Selecciona una--</option>
                            <option value="kg">kg</option>
                            <option value="reja">Reja</option>
                            <option value="tonelada">Tonelada</option>
                        </select>
                        <div id="unidad-mensaje" class="unidad-mensaje" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>M√≠nimo 5 kg por unidad</span>
                        </div>
                        <div id="unidad-error" class="field-error" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Debes seleccionar una unidad</span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio">Precio (MXN):</label>
                        <input type="number" id="precio" name="precio" min="0" step="0.01" placeholder="25.50" required>
                        <div id="precio-error" class="field-error" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="precio-error-texto"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="stock">Cantidad disponible:</label>
                        <input type="number" id="stock" name="stock" min="1" step="1" placeholder="100" required>
                        <div id="stock-mensaje" class="stock-mensaje" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span id="stock-mensaje-texto">M√≠nimo 5 unidades</span>
                        </div>
                        <div id="stock-error" class="stock-error" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>El m√≠nimo son 5 kg. No se permiten valores menores.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Im√°genes y bot√≥n -->
            <div class="form-right-column">
                <div class="form-group">
                    <label for="imagen">Im√°genes del producto:</label>
                    <div class="image-upload-container">
                        <input type="file" id="imagen" name="imagen" accept="image/*" multiple style="display: none;">
                        <div class="image-upload-area" id="imageUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Haz clic para seleccionar una o m√°s im√°genes</p>
                            <small>Formatos: JPG, PNG, GIF (m√°x. 5MB cada una. M√°ximo 5 im√°genes)</small>
                        </div>
                        <div class="images-preview-container" id="imagesPreviewContainer" style="display: none;">
                            <div class="images-grid" id="imagesGrid">
                                <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
                            </div>
                            <div class="images-actions">
                                <button type="button" id="addMoreImagesBtn" class="add-more-images-btn">
                                    <i class="fas fa-plus"></i> Subir m√°s im√°genes
                                </button>
                                <button type="button" id="removeAllImages" class="remove-all-btn">
                                    <i class="fas fa-trash"></i> Eliminar todas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-upload"></i> Publicar Producto
                </button>
            </div>
        </form>
    </div>
</main>

<!-- Script unificado para toda la funcionalidad -->
<script>
    console.log('üöÄ Iniciando script unificado...');
    
    // Variables globales
    let imagenesSeleccionadas = []; // Array para m√∫ltiples im√°genes
    let auth = null;
    let db = null;
    let storage = null;
    let currentUser = null;

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDZWmY0ggZthOKv17yHH57pkXsie_U2YnI",
        authDomain: "agromarket-625b2.firebaseapp.com",
        projectId: "agromarket-625b2",
        storageBucket: "agromarket-625b2.firebasestorage.app",
        messagingSenderId: "18163605615",
        appId: "1:18163605615:web:6910d608e280b028d6ad9a",
        measurementId: "G-CVL9DRNMG1"
    };

    // Funci√≥n para mostrar mensajes
    function mostrarMensaje(mensaje, tipo) {
        console.log(`üì¢ Mensaje: ${mensaje} (${tipo})`);
        
        let messageDiv = document.getElementById('message');
        if (!messageDiv) {
            messageDiv = document.createElement('div');
            messageDiv.id = 'message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                max-width: 300px;
            `;
            document.body.appendChild(messageDiv);
        }

        messageDiv.textContent = mensaje;
        messageDiv.className = `message ${tipo}`;
        
        if (tipo === 'success') {
            messageDiv.style.backgroundColor = '#4CAF50';
        } else if (tipo === 'error') {
            messageDiv.style.backgroundColor = '#f44336';
        } else {
            messageDiv.style.backgroundColor = '#2196F3';
        }

        messageDiv.style.display = 'block';

        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
            if (auth) {
                auth.signOut().then(() => {
                    console.log('‚úÖ Sesi√≥n cerrada correctamente');
                    window.location.href = '/auth/login';
                }).catch((error) => {
                    console.error('‚ùå Error al cerrar sesi√≥n:', error);
                    alert('Error al cerrar sesi√≥n. Intenta de nuevo.');
                });
            } else {
                console.log('‚ö†Ô∏è Auth no disponible, redirigiendo directamente');
                window.location.href = '/auth/login';
            }
        }
    }

    // Funci√≥n para guardar producto en Firestore
    async function guardarProducto(datosProducto) {
        try {
            console.log('üíæ Guardando producto en Firestore...');
            
            // Verificar que Firebase est√© inicializado
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK no est√° cargado');
            }
            
            if (!db) {
                // Intentar obtener la instancia de Firestore
                db = firebase.firestore();
                if (!db) {
                    throw new Error('Firestore no est√° inicializado');
                }
            }
            
            if (!currentUser) {
                throw new Error('Usuario no autenticado');
            }
            
            // Validar datos del producto
            if (!datosProducto.nombre || datosProducto.nombre.trim().length < 3) {
                throw new Error('El nombre del producto debe tener al menos 3 caracteres');
            }
            
            if (!datosProducto.descripcion || datosProducto.descripcion.trim().length < 10) {
                throw new Error('La descripci√≥n debe tener al menos 10 caracteres');
            }
            
            if (datosProducto.precio <= 0) {
                throw new Error('El precio debe ser mayor a 0');
            }
            
            if (datosProducto.stock <= 0) {
                throw new Error('El stock debe ser mayor a 0');
            }
            
            // Validaci√≥n espec√≠fica para kg
            if (datosProducto.unidad === 'kg' && datosProducto.stock < 5) {
                throw new Error('El m√≠nimo son 5 kg. No se permiten valores menores a 5.');
            }
            
            // Agregar metadatos del producto
            const productoCompleto = {
                nombre: datosProducto.nombre.trim(),
                descripcion: datosProducto.descripcion.trim(),
                categoria: datosProducto.categoria,
                unidad: datosProducto.unidad,
                precio: parseFloat(datosProducto.precio),
                stock: parseInt(datosProducto.stock),
                vendedor_id: currentUser.uid,
                vendedor_email: currentUser.email,
                vendedor_nombre: currentUser.displayName || currentUser.email.split('@')[0],
                fecha_publicacion: firebase.firestore.FieldValue.serverTimestamp(),
                fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp(),
                activo: true,
                vendido: 0,
                calificacion_promedio: 0,
                total_calificaciones: 0
            };
            
            console.log('üìã Datos del producto a guardar:', productoCompleto);
            
            // Guardar en Firestore
            const docRef = await db.collection('productos').add(productoCompleto);
            console.log('‚úÖ Producto guardado con ID:', docRef.id);
            
            return docRef.id;
            
        } catch (error) {
            console.error('‚ùå Error guardando producto:', error);
            throw error;
        }
    }

    // Funci√≥n para subir imagen a Firebase Storage
    async function subirImagen(archivo, productoId, indice) {
        try {
            console.log(`üì§ Subiendo imagen ${indice + 1} a Firebase Storage...`);
            
            // Verificar que Firebase est√© inicializado
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK no est√° cargado');
            }
            
            if (!storage) {
                // Intentar obtener la instancia de Storage
                storage = firebase.storage();
                if (!storage) {
                    throw new Error('Firebase Storage no est√° inicializado');
                }
            }
            
            // Validar archivo
            if (!archivo) {
                throw new Error('No se seleccion√≥ ning√∫n archivo');
            }
            
            // Validar tipo de archivo
            const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!tiposPermitidos.includes(archivo.type)) {
                throw new Error('Tipo de archivo no permitido. Use JPG, PNG, GIF o WebP');
            }
            
            // Validar tama√±o (5MB m√°ximo)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (archivo.size > maxSize) {
                throw new Error('El archivo es demasiado grande. M√°ximo 5MB');
            }
            
            // Crear nombre √∫nico para el archivo
            const timestamp = Date.now();
            const extension = archivo.name.split('.').pop();
            const nombreArchivo = `productos/${productoId}/imagen_${indice}_${timestamp}.${extension}`;
            const storageRef = storage.ref(nombreArchivo);
            
            console.log('üìÅ Subiendo archivo:', nombreArchivo);
            
            // Subir archivo con metadata
            const metadata = {
                contentType: archivo.type,
                customMetadata: {
                    productoId: productoId,
                    vendedorId: currentUser.uid,
                    fechaSubida: new Date().toISOString(),
                    indice: indice.toString()
                }
            };
            
            const snapshot = await storageRef.put(archivo, metadata);
            console.log('‚úÖ Imagen subida:', snapshot.metadata.name);
            
            // Obtener URL de descarga
            const downloadURL = await snapshot.ref.getDownloadURL();
            console.log('üîó URL de descarga:', downloadURL);
            
            return downloadURL;
            
        } catch (error) {
            console.error('‚ùå Error subiendo imagen:', error);
            throw error;
        }
    }

    // Funci√≥n para subir m√∫ltiples im√°genes
    async function subirImagenes(productoId) {
        if (!imagenesSeleccionadas || imagenesSeleccionadas.length === 0) {
            return [];
        }
        
        const urls = [];
        for (let i = 0; i < imagenesSeleccionadas.length; i++) {
            const url = await subirImagen(imagenesSeleccionadas[i], productoId, i);
            urls.push(url);
        }
        return urls;
    }

    // Configurar todo cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM cargado - Configurando todo...');
        
        // Configurar formulario
        const form = document.getElementById('productForm');
        if (form) {
            console.log('‚úÖ Formulario encontrado');
            
            // Manejar env√≠o del formulario
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üìù Procesando formulario...');
                
                try {
                    // Mostrar mensaje de carga
                    mostrarMensaje('‚è≥ Guardando producto...', 'info');
                    
                    // Recopilar datos del formulario
                    const datosProducto = {
                        nombre: document.getElementById('nombre').value.trim(),
                        descripcion: document.getElementById('descripcion').value.trim(),
                        categoria: document.getElementById('categoria').value,
                        unidad: document.getElementById('unidad').value,
                        precio: parseFloat(document.getElementById('precio').value),
                        stock: parseInt(document.getElementById('stock').value)
                    };
                    
                    // Validar datos b√°sicos
                    if (!datosProducto.nombre || !datosProducto.descripcion || !datosProducto.categoria) {
                        throw new Error('Por favor completa todos los campos obligatorios');
                    }
                    
                    if (isNaN(datosProducto.precio) || datosProducto.precio <= 0) {
                        throw new Error('El precio debe ser un n√∫mero mayor a 0');
                    }
                    
                    if (isNaN(datosProducto.stock) || datosProducto.stock <= 0) {
                        throw new Error('El stock debe ser un n√∫mero mayor a 0');
                    }
                    
                    // Validaci√≥n espec√≠fica para kg
                    if (datosProducto.unidad === 'kg' && datosProducto.stock < 5) {
                        throw new Error('El m√≠nimo son 5 kg. No se permiten valores menores a 5.');
                    }
                    
                    // Validar longitud m√≠nima
                    if (datosProducto.nombre.trim().length < 3) {
                        throw new Error('El nombre debe tener al menos 3 caracteres');
                    }
                    
                    if (datosProducto.descripcion.trim().length < 10) {
                        throw new Error('La descripci√≥n debe tener al menos 10 caracteres');
                    }
                    
                    // Guardar producto en Firestore
                    mostrarMensaje('üíæ Guardando producto...', 'info');
                    const productoId = await guardarProducto(datosProducto);
                    
                    // Subir im√°genes si existen
                    if (imagenesSeleccionadas && imagenesSeleccionadas.length > 0) {
                        mostrarMensaje(`üì§ Subiendo ${imagenesSeleccionadas.length} imagen(es)...`, 'info');
                        const imagenesUrls = await subirImagenes(productoId);
                        
                        // Actualizar producto con URLs de im√°genes
                        // La primera imagen es la principal
                        const updateData = {
                            imagen: imagenesUrls[0] || null,
                            imagenes: imagenesUrls,
                            fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await db.collection('productos').doc(productoId).update(updateData);
                        
                        console.log('‚úÖ Im√°genes actualizadas en el producto:', imagenesUrls.length);
                    }
                    
                    // √âxito
                    console.log('‚úÖ Producto guardado exitosamente');
                    mostrarMensaje('‚úÖ ¬°Producto guardado exitosamente!', 'success');
                    
                    // Limpiar formulario
                    form.reset();
                    if (imageUploadArea) imageUploadArea.style.display = 'block';
                    if (imagesPreviewContainer) imagesPreviewContainer.style.display = 'none';
                    imagenesSeleccionadas = [];
                    const imagesGrid = document.getElementById('imagesGrid');
                    if (imagesGrid) imagesGrid.innerHTML = '';
                    
                    // Redirigir despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/vendedor/mis_productos';
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Error guardando producto:', error);
                    mostrarMensaje('‚ùå Error: ' + error.message, 'error');
                }
            });
        } else {
            console.error('‚ùå Formulario no encontrado');
        }

        // Configurar manejo de im√°genes m√∫ltiples
        const imagenInput = document.getElementById('imagen');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagesPreviewContainer = document.getElementById('imagesPreviewContainer');
        const imagesGrid = document.getElementById('imagesGrid');
        const removeAllImagesBtn = document.getElementById('removeAllImages');
        
        // Funci√≥n para mostrar vista previa de im√°genes
        function mostrarVistasPrevia() {
            const addMoreBtn = document.getElementById('addMoreImagesBtn');
            const maxImages = 5;
            
            if (imagenesSeleccionadas.length === 0) {
                if (imageUploadArea) imageUploadArea.style.display = 'block';
                if (imagesPreviewContainer) imagesPreviewContainer.style.display = 'none';
                if (imagesGrid) imagesGrid.innerHTML = '';
                return;
            }
            
            // Siempre mostrar el contenedor de im√°genes si hay al menos una
            if (imageUploadArea) imageUploadArea.style.display = 'none';
            if (imagesPreviewContainer) imagesPreviewContainer.style.display = 'block';
            
            // Mostrar grid de im√°genes
            if (imagesGrid) {
                imagesGrid.innerHTML = imagenesSeleccionadas.map((archivo, index) => {
                    const url = URL.createObjectURL(archivo);
                    return `
                        <div class="image-preview-item" data-index="${index}">
                            <img src="${url}" alt="Vista previa ${index + 1}">
                            <button type="button" class="remove-image-btn" onclick="removerImagen(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                            ${index === 0 ? '<span class="primary-badge">Principal</span>' : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // Mostrar/ocultar bot√≥n "Subir m√°s im√°genes" seg√∫n el n√∫mero de im√°genes
            if (addMoreBtn) {
                if (imagenesSeleccionadas.length < maxImages) {
                    addMoreBtn.style.display = 'flex';
                } else {
                    addMoreBtn.style.display = 'none';
                }
            }
        }
        
        // Funci√≥n para remover una imagen espec√≠fica
        window.removerImagen = function(index) {
            console.log('üóëÔ∏è Removiendo imagen', index);
            imagenesSeleccionadas.splice(index, 1);
            mostrarVistasPrevia();
            
            // Actualizar input file
            if (imagenInput) {
                const dt = new DataTransfer();
                imagenesSeleccionadas.forEach(archivo => dt.items.add(archivo));
                imagenInput.files = dt.files;
            }
        };
        
        if (imagenInput && imageUploadArea) {
            console.log('‚úÖ Elementos de imagen encontrados');
            
            // Hacer clic en el √°rea de subida
            imageUploadArea.addEventListener('click', function() {
                console.log('üñ±Ô∏è Clic en √°rea de subida');
                imagenInput.click();
            });
            
            // Manejar selecci√≥n de archivos m√∫ltiples
            imagenInput.addEventListener('change', function(e) {
                console.log('üìÅ Archivos seleccionados');
                const archivos = Array.from(e.target.files);
                
                if (archivos.length === 0) return;
                
                // Validar n√∫mero m√°ximo de im√°genes (5)
                const maxImages = 5;
                if (archivos.length > maxImages) {
                    alert(`‚ùå Puedes seleccionar m√°ximo ${maxImages} im√°genes`);
                    // Mantener solo las primeras 5
                    archivos.splice(maxImages);
                }
                
                // Validar cada archivo
                const archivosValidos = [];
                archivos.forEach((archivo, index) => {
                    console.log(`üìÑ Archivo ${index + 1}:`, archivo.name, archivo.size, archivo.type);

                    // Validar tipo de archivo
                    if (!archivo.type.startsWith('image/')) {
                        alert(`‚ùå El archivo "${archivo.name}" no es una imagen v√°lida`);
                        return;
                    }

                    // Validar tama√±o (5MB m√°ximo)
                    if (archivo.size > 5 * 1024 * 1024) {
                        alert(`‚ùå La imagen "${archivo.name}" es demasiado grande. M√°ximo 5MB`);
                        return;
                    }

                    archivosValidos.push(archivo);
                });
                
                // Verificar cu√°ntas im√°genes podemos agregar
                const espaciosDisponibles = maxImages - imagenesSeleccionadas.length;
                
                if (espaciosDisponibles <= 0) {
                    alert(`‚ùå Ya has seleccionado el m√°ximo de ${maxImages} im√°genes`);
                    return;
                }
                
                // Agregar solo las im√°genes que quepan
                const imagenesAAgregar = archivosValidos.slice(0, espaciosDisponibles);
                imagenesSeleccionadas = [...imagenesSeleccionadas, ...imagenesAAgregar];
                
                if (archivosValidos.length > espaciosDisponibles) {
                    alert(`‚ö†Ô∏è Solo se agregaron ${espaciosDisponibles} imagen(es). Ya tienes ${maxImages} im√°genes en total.`);
                }
                
                mostrarVistasPrevia();
                console.log(`‚úÖ ${imagenesSeleccionadas.length} imagen(es) seleccionada(s)`);
            });
            
            // Bot√≥n para remover todas las im√°genes
            if (removeAllImagesBtn) {
                removeAllImagesBtn.addEventListener('click', function() {
                    console.log('üóëÔ∏è Removiendo todas las im√°genes');
                    imagenesSeleccionadas = [];
                    if (imagenInput) imagenInput.value = '';
                    mostrarVistasPrevia();
                });
            }
            
            // Bot√≥n para agregar m√°s im√°genes
            const addMoreImagesBtn = document.getElementById('addMoreImagesBtn');
            if (addMoreImagesBtn) {
                addMoreImagesBtn.addEventListener('click', function() {
                    console.log('‚ûï Agregando m√°s im√°genes');
                    imagenInput.click();
                });
            }
        } else {
            console.error('‚ùå Elementos de imagen no encontrados');
        }

        // Configurar validaci√≥n de unidad
        const unidadSelect = document.getElementById('unidad');
        const unidadMensaje = document.getElementById('unidad-mensaje');
        const stockInput = document.getElementById('stock');
        const stockMensaje = document.getElementById('stock-mensaje');
        const stockMensajeTexto = document.getElementById('stock-mensaje-texto');
        const stockError = document.getElementById('stock-error');

        // Funci√≥n para validar stock basado en unidad
        function validarStock() {
            const unidad = unidadSelect.value;
            const stock = parseInt(stockInput.value) || 0;
            
            if (unidad === 'kg') {
                // Los mensajes informativos ya se muestran al cambiar la unidad
                // Solo validar el valor
                if (stock > 0 && stock < 5) {
                    // Mostrar error
                    if (stockError) {
                        stockError.style.display = 'flex';
                    }
                    if (stockInput) {
                        stockInput.setCustomValidity('El m√≠nimo son 5 kg. No se permiten valores menores a 5.');
                        stockInput.style.borderColor = '#dc3545';
                    }
                    return false;
                } else {
                    // Ocultar error
                    if (stockError) {
                        stockError.style.display = 'none';
                    }
                    if (stockInput) {
                        stockInput.setCustomValidity('');
                        stockInput.style.borderColor = '';
                    }
                    return true;
                }
            } else {
                // Ocultar mensajes
                if (stockMensaje) {
                    stockMensaje.style.display = 'none';
                }
                if (unidadMensaje) {
                    unidadMensaje.style.display = 'none';
                }
                if (stockError) {
                    stockError.style.display = 'none';
                }
                if (stockInput) {
                    stockInput.setCustomValidity('');
                    stockInput.style.borderColor = '';
                }
                return true;
            }
        }

        if (unidadSelect && stockInput) {
            // Validar cuando cambia la unidad
            unidadSelect.addEventListener('change', (e) => {
                if (e.target.value === 'kg') {
                    // Mostrar mensaje inmediatamente
                    if (unidadMensaje) {
                        unidadMensaje.style.display = 'flex';
                    }
                    if (stockMensaje && stockMensajeTexto) {
                        stockMensaje.style.display = 'flex';
                        stockMensajeTexto.textContent = 'M√≠nimo 5 kg';
                    }
                    stockInput.min = 5;
                    // Si ya hay un valor, validarlo
                    if (stockInput.value) {
                        validarStock();
                    }
                } else {
                    // Ocultar mensajes inmediatamente
                    if (unidadMensaje) {
                        unidadMensaje.style.display = 'none';
                    }
                    if (stockMensaje) {
                        stockMensaje.style.display = 'none';
                    }
                    if (stockError) {
                        stockError.style.display = 'none';
                    }
                    stockInput.min = 1;
                    validarStock();
                }
            });
            
            // Validar en tiempo real cuando el usuario escribe
            stockInput.addEventListener('input', () => {
                validarStock();
            });
            
            // Validar cuando el campo pierde el foco
            stockInput.addEventListener('blur', () => {
                validarStock();
            });
            
            // Validar inicialmente si ya hay un valor
            if (unidadSelect.value === 'kg' && stockInput.value) {
                validarStock();
            }
        }

        // ============================================
        // VALIDACIONES EN TIEMPO REAL PARA TODOS LOS CAMPOS
        // ============================================
        
        // Validaci√≥n de nombre
        const nombreInput = document.getElementById('nombre');
        const nombreError = document.getElementById('nombre-error');
        const nombreErrorTexto = document.getElementById('nombre-error-texto');
        
        if (nombreInput && nombreError && nombreErrorTexto) {
            nombreInput.addEventListener('blur', () => {
                const nombre = nombreInput.value.trim();
                if (nombre.length === 0) {
                    nombreError.style.display = 'flex';
                    nombreErrorTexto.textContent = 'El nombre es obligatorio';
                    nombreInput.style.borderColor = '#dc3545';
                } else if (nombre.length < 3) {
                    nombreError.style.display = 'flex';
                    nombreErrorTexto.textContent = 'El nombre debe tener al menos 3 caracteres';
                    nombreInput.style.borderColor = '#dc3545';
                } else if (nombre.length > 100) {
                    nombreError.style.display = 'flex';
                    nombreErrorTexto.textContent = 'El nombre no puede exceder 100 caracteres';
                    nombreInput.style.borderColor = '#dc3545';
                } else {
                    nombreError.style.display = 'none';
                    nombreInput.style.borderColor = '';
                }
            });
            
            nombreInput.addEventListener('input', () => {
                if (nombreInput.value.trim().length >= 3 && nombreInput.value.trim().length <= 100) {
                    nombreError.style.display = 'none';
                    nombreInput.style.borderColor = '';
                }
            });
        }
        
        // Validaci√≥n de descripci√≥n
        const descripcionTextarea = document.getElementById('descripcion');
        const descripcionError = document.getElementById('descripcion-error');
        const descripcionErrorTexto = document.getElementById('descripcion-error-texto');
        const descripcionCounter = document.getElementById('descripcion-counter');
        
        if (descripcionTextarea && descripcionError && descripcionErrorTexto && descripcionCounter) {
            // Actualizar contador
            descripcionTextarea.addEventListener('input', () => {
                const length = descripcionTextarea.value.length;
                descripcionCounter.textContent = length;
                
                if (length < 10) {
                    descripcionError.style.display = 'flex';
                    descripcionErrorTexto.textContent = `M√≠nimo 10 caracteres (${length}/10)`;
                    descripcionTextarea.style.borderColor = '#dc3545';
                } else if (length > 1000) {
                    descripcionError.style.display = 'flex';
                    descripcionErrorTexto.textContent = 'M√°ximo 1000 caracteres';
                    descripcionTextarea.style.borderColor = '#dc3545';
                } else {
                    descripcionError.style.display = 'none';
                    descripcionTextarea.style.borderColor = '';
                }
            });
            
            descripcionTextarea.addEventListener('blur', () => {
                const descripcion = descripcionTextarea.value.trim();
                if (descripcion.length === 0) {
                    descripcionError.style.display = 'flex';
                    descripcionErrorTexto.textContent = 'La descripci√≥n es obligatoria';
                    descripcionTextarea.style.borderColor = '#dc3545';
                } else if (descripcion.length < 10) {
                    descripcionError.style.display = 'flex';
                    descripcionErrorTexto.textContent = 'La descripci√≥n debe tener al menos 10 caracteres';
                    descripcionTextarea.style.borderColor = '#dc3545';
                } else if (descripcion.length > 1000) {
                    descripcionError.style.display = 'flex';
                    descripcionErrorTexto.textContent = 'La descripci√≥n no puede exceder 1000 caracteres';
                    descripcionTextarea.style.borderColor = '#dc3545';
                } else {
                    descripcionError.style.display = 'none';
                    descripcionTextarea.style.borderColor = '';
                }
            });
        }
        
        // Validaci√≥n de categor√≠a
        const categoriaSelect = document.getElementById('categoria');
        const categoriaError = document.getElementById('categoria-error');
        
        if (categoriaSelect && categoriaError) {
            categoriaSelect.addEventListener('change', () => {
                if (categoriaSelect.value === '') {
                    categoriaError.style.display = 'flex';
                    categoriaSelect.style.borderColor = '#dc3545';
                } else {
                    categoriaError.style.display = 'none';
                    categoriaSelect.style.borderColor = '';
                }
            });
        }
        
        // Validaci√≥n de unidad
        const unidadError = document.getElementById('unidad-error');
        
        if (unidadSelect && unidadError) {
            unidadSelect.addEventListener('change', () => {
                if (unidadSelect.value === '') {
                    unidadError.style.display = 'flex';
                    unidadSelect.style.borderColor = '#dc3545';
                } else {
                    unidadError.style.display = 'none';
                    unidadSelect.style.borderColor = '';
                }
            });
        }
        
        // Validaci√≥n de precio
        const precioInput = document.getElementById('precio');
        const precioError = document.getElementById('precio-error');
        const precioErrorTexto = document.getElementById('precio-error-texto');
        
        if (precioInput && precioError && precioErrorTexto) {
            precioInput.addEventListener('blur', () => {
                const precio = parseFloat(precioInput.value);
                if (isNaN(precio) || precioInput.value === '') {
                    precioError.style.display = 'flex';
                    precioErrorTexto.textContent = 'El precio es obligatorio';
                    precioInput.style.borderColor = '#dc3545';
                } else if (precio <= 0) {
                    precioError.style.display = 'flex';
                    precioErrorTexto.textContent = 'El precio debe ser mayor a 0';
                    precioInput.style.borderColor = '#dc3545';
                } else {
                    precioError.style.display = 'none';
                    precioInput.style.borderColor = '';
                }
            });
            
            precioInput.addEventListener('input', () => {
                const precio = parseFloat(precioInput.value);
                if (!isNaN(precio) && precio > 0) {
                    precioError.style.display = 'none';
                    precioInput.style.borderColor = '';
                }
            });
        }
        
        // Validaci√≥n de stock (adem√°s de la validaci√≥n especial de kg)
        if (stockInput && stockError) {
            stockInput.addEventListener('blur', () => {
                const stock = parseInt(stockInput.value);
                const unidad = unidadSelect ? unidadSelect.value : '';
                
                if (isNaN(stock) || stockInput.value === '') {
                    stockError.style.display = 'flex';
                    stockError.querySelector('span').textContent = 'La cantidad es obligatoria';
                    stockInput.style.borderColor = '#dc3545';
                } else if (stock <= 0) {
                    stockError.style.display = 'flex';
                    stockError.querySelector('span').textContent = 'La cantidad debe ser mayor a 0';
                    stockInput.style.borderColor = '#dc3545';
                } else if (unidad === 'kg' && stock < 5) {
                    stockError.style.display = 'flex';
                    stockError.querySelector('span').textContent = 'El m√≠nimo son 5 kg. No se permiten valores menores.';
                    stockInput.style.borderColor = '#dc3545';
                } else if (unidad !== 'kg') {
                    // Solo ocultar error si no es kg o si es kg y >= 5
                    stockError.style.display = 'none';
                    stockInput.style.borderColor = '';
                }
            });
        }

        // Funci√≥n para inicializar Firebase
        function inicializarFirebase() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üî• Inicializando Firebase...');
                    
                    // Verificar si Firebase est√° disponible
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase SDK no est√° cargado');
                    }
                    
                    // Verificar si Firebase ya est√° inicializado
                    if (firebase.apps.length === 0) {
                        // Inicializar Firebase
                        firebase.initializeApp(firebaseConfig);
                        console.log('‚úÖ Firebase inicializado');
                    } else {
                        console.log('‚úÖ Firebase ya estaba inicializado');
                    }
                    
                    // Obtener instancias de Firebase
                    auth = firebase.auth();
                    db = firebase.firestore();
                    storage = firebase.storage();
                    
                    // Configurar Firestore
                    db.settings({
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                        ignoreUndefinedProperties: true
                    });
                    
                    console.log('‚úÖ Instancias de Firebase obtenidas');
                    resolve({ auth, db, storage });
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando Firebase:', error);
                    reject(error);
                }
            });
        }

        // Inicializar Firebase
        inicializarFirebase().then(() => {
            console.log('üî• Firebase inicializado correctamente');
            
            // Verificar autenticaci√≥n
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('üë§ Usuario autenticado:', user.email);
                } else {
                    console.log('üë§ Usuario no autenticado');
                    // Redirigir al login si no est√° autenticado
                    window.location.href = '/auth/login';
                }
            });
            
        }).catch((error) => {
            console.error('‚ùå Error inicializando Firebase:', error);
            mostrarMensaje('‚ùå Error de conexi√≥n. Recarga la p√°gina.', 'error');
        });

        console.log('‚úÖ Todo configurado correctamente');
    });
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Firebase Instant -->
<script src="/static/js/firebase-instant.js"></script>
</body>
</html>