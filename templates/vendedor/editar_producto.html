<!DOCTYPE html>
<html lang="es">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Producto - AgroMarket</title>
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/estilos_vendedor.css">
    <link rel="stylesheet" href="/static/css/formulario_productos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Producto - AgroMarket</title>

  <!-- PWA: Manifest y theme color -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#2e8b57">

  <!-- Iconos -->
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icons/icons-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='images/icons/icons-512.png') }}">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Caveat:wght@600;700&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_vendedor.css') }}">
</head>

<body>
<nav>
    <div class="nav-left">
        <div class="logo"><h2>AgroMarket</h2></div>
        <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
    </div>
    <div class="menu">
        <a href="/vendedor/panel">Home</a>
        <a href="/vendedor/agregar_producto">Agregar Productos</a>
        <a href="/vendedor/mis_productos" class="activo">Mis Productos</a>
        <a href="#" onclick="alert('Funci√≥n pr√≥ximamente')">Ventas</a>
        <a href="/auth/perfil">Mi Perfil</a>
        <a href="#" onclick="cerrarSesion()">Cerrar Sesi√≥n</a>
    </div>
</nav>

<main>
    <h1>Editar Producto</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="product-form-container">
        <form id="productForm" class="form-two-columns">
            <!-- Columna izquierda: Campos del formulario -->
            <div class="form-left-column">
                <div class="form-group">
                    <label for="nombre">Nombre del producto:</label>
                    <input type="text" id="nombre" name="nombre" placeholder="Ej: Manzanas rojas" required>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripci√≥n:</label>
                    <textarea id="descripcion" name="descripcion" placeholder="Describe tu producto, origen, caracter√≠sticas especiales, etc." required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="categoria">Categor√≠a:</label>
                        <select id="categoria" name="categoria" required>
                            <option value="">--Selecciona una--</option>
                            <option value="frutas">Frutas</option>
                            <option value="verduras">Verduras</option>
                            <option value="granos">Granos</option>
                            <option value="lacteos">L√°cteos</option>
                            <option value="carnes">Carnes</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="unidad">Unidad:</label>
                        <select id="unidad" name="unidad" required>
                            <option value="">--Selecciona una--</option>
                            <option value="kg">Kilogramo (kg)</option>
                            <option value="g">Gramo (g)</option>
                            <option value="l">Litro (l)</option>
                            <option value="ml">Mililitro (ml)</option>
                            <option value="pieza">Pieza</option>
                            <option value="caja">Caja</option>
                            <option value="bolsa">Bolsa</option>
                            <option value="reja">Reja</option>
                        </select>
                        <div id="unidad-mensaje" class="unidad-mensaje" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>M√≠nimo 5 kg</span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio">Precio (MXN):</label>
                        <input type="number" id="precio" name="precio" min="0" step="0.01" placeholder="25.50" required>
                    </div>
                    <div class="form-group">
                        <label for="stock">Cantidad disponible:</label>
                        <input type="number" id="stock" name="stock" min="1" step="1" placeholder="100" required>
                        <div id="stock-mensaje" class="stock-mensaje" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>M√≠nimo 5 unidades</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Im√°genes y botones -->
            <div class="form-right-column">
                <div class="form-group">
                    <label for="imagen">Im√°genes del producto:</label>
                    <div class="image-upload-container">
                        <input type="file" id="imagen" name="imagen" accept="image/*" multiple style="display: none;">
                        <div class="image-upload-area" id="imageUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Haz clic para seleccionar una o m√°s im√°genes</p>
                            <small>Formatos: JPG, PNG, GIF (m√°x. 5MB cada una. M√°ximo 5 im√°genes)</small>
                        </div>
                        <div class="images-preview-container" id="imagesPreviewContainer" style="display: none;">
                            <div class="images-grid" id="imagesGrid">
                                <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
                            </div>
                            <div class="images-actions">
                                <button type="button" id="addMoreImagesBtn" class="add-more-images-btn">
                                    <i class="fas fa-plus"></i> Subir m√°s im√°genes
                                </button>
                                <button type="button" id="removeAllImages" class="remove-all-btn">
                                    <i class="fas fa-trash"></i> Eliminar todas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> Actualizar Producto
                    </button>
                    <button type="button" class="cancel-btn" onclick="cancelarEdicion()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </form>
    </div>
</main>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("{{ url_for('static', filename='js/service-worker.js') }}")
    .then((reg) => console.log("‚úÖ Service Worker registrado:", reg))
    .catch((err) => console.error("‚ùå Error al registrar el SW:", err));
  }
</script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos del DOM
        const form = document.getElementById('productForm');
        const unidadSelect = document.getElementById('unidad');
        const unidadMensaje = document.getElementById('unidad-mensaje');
        const stockInput = document.getElementById('stock');
        const stockMensaje = document.getElementById('stock-mensaje');

        console.log('DOM cargado - Editar producto');

        // Manejo del mensaje de unidad y validaci√≥n de cantidad
        if (unidadSelect && unidadMensaje && stockMensaje && stockInput) {
            unidadSelect.addEventListener('change', (e) => {
                if (e.target.value === 'kg') {
                    unidadMensaje.style.display = 'flex';
                    stockMensaje.style.display = 'flex';
                    stockInput.min = 5;
                } else {
                    unidadMensaje.style.display = 'none';
                    stockMensaje.style.display = 'none';
                    stockInput.min = 1;
                }
            });
        }
    });
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDZWmY0ggZthOKv17yHH57pkXsie_U2YnI",
        authDomain: "agromarket-625b2.firebaseapp.com",
        projectId: "agromarket-625b2",
        storageBucket: "agromarket-625b2.firebasestorage.app",
        messagingSenderId: "18163605615",
        appId: "1:18163605615:web:6910d608e280b028d6ad9a",
        measurementId: "G-CVL9DRNMG1"
    };

    // Variables globales
    let auth = null;
    let db = null;
    let storage = null;
    let currentUser = null;

    // Funci√≥n para inicializar Firebase
    function inicializarFirebase() {
        return new Promise((resolve, reject) => {
            try {
                console.log('üî• Inicializando Firebase...');
                
                // Verificar si Firebase est√° disponible
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no est√° cargado');
                }
                
                // Verificar si Firebase ya est√° inicializado
                if (firebase.apps.length === 0) {
                    // Inicializar Firebase
                    firebase.initializeApp(firebaseConfig);
                    console.log('‚úÖ Firebase inicializado');
                } else {
                    console.log('‚úÖ Firebase ya estaba inicializado');
                }
                
                // Obtener instancias de Firebase
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                // Configurar Firestore
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true
                });
                
                console.log('‚úÖ Instancias de Firebase obtenidas');
                resolve({ auth, db, storage });
                
            } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                reject(error);
            }
        });
    }

    // Variables globales
    let imagenesSeleccionadas = []; // Array para nuevas im√°genes seleccionadas
    let imagenesExistentes = []; // Array para im√°genes que ya tiene el producto
    let productoActual = null;
    const productoId = '{{ producto_id }}';

    // Funci√≥n para mostrar mensajes
    function mostrarMensaje(mensaje, tipo) {
        // Remover mensaje anterior si existe
        const existingMessage = document.getElementById('message');
        if (existingMessage) {
            existingMessage.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.id = 'message';
        
        const bgColor = tipo === 'success' ? '#d4edda' : '#f8d7da';
        const textColor = tipo === 'success' ? '#155724' : '#721c24';
        const borderColor = tipo === 'success' ? '#c3e6cb' : '#f5c6cb';
        const icon = tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        const iconColor = tipo === 'success' ? '#28a745' : '#dc3545';
        
        messageDiv.innerHTML = `
            <div style="
                position: fixed;
                top: 20px;
                right: -400px;
                background: ${bgColor};
                color: ${textColor};
                padding: 15px 20px;
                border-radius: 8px;
                border: 1px solid ${borderColor};
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 500;
                max-width: 400px;
                transition: right 0.3s ease-in-out;
            ">
                <i class="fas ${icon}" style="color: ${iconColor}; font-size: 18px;"></i>
                <span>${mensaje}</span>
            </div>
        `;
        
        document.body.appendChild(messageDiv);
        
        // Animar entrada desde la orilla
        setTimeout(() => {
            const notification = messageDiv.querySelector('div');
            notification.style.right = '20px';
        }, 100);
        
        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            const notification = messageDiv.querySelector('div');
            notification.style.right = '-400px';
            setTimeout(() => {
                messageDiv.remove();
            }, 300);
        }, 3000);
    }

    // Funci√≥n para mostrar vista previa de todas las im√°genes (existentes + nuevas)
    function mostrarVistasPrevia() {
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagesPreviewContainer = document.getElementById('imagesPreviewContainer');
        const imagesGrid = document.getElementById('imagesGrid');
        const addMoreBtn = document.getElementById('addMoreImagesBtn');
        const maxImages = 5;
        const totalImagenes = imagenesExistentes.length + imagenesSeleccionadas.length;
        
        if (totalImagenes === 0) {
            if (imageUploadArea) imageUploadArea.style.display = 'block';
            if (imagesPreviewContainer) imagesPreviewContainer.style.display = 'none';
            return;
        }
        
        if (imageUploadArea) imageUploadArea.style.display = 'none';
        if (imagesPreviewContainer) imagesPreviewContainer.style.display = 'block';
        
        // Crear HTML con im√°genes existentes primero, luego las nuevas
        let html = '';
        
        // Im√°genes existentes
        imagenesExistentes.forEach((url, index) => {
            html += `
                <div class="image-preview-item" data-index="${index}" data-existing="true" data-url="${url}">
                    <img src="${url}" alt="Imagen ${index + 1}" onerror="this.src='/static/images/product-placeholder.png'">
                    <button type="button" class="remove-image-btn" onclick="removerImagenExistente(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    ${index === 0 && imagenesSeleccionadas.length === 0 ? '<span class="primary-badge">Principal</span>' : ''}
                </div>
            `;
        });
        
        // Im√°genes nuevas seleccionadas
        imagenesSeleccionadas.forEach((archivo, index) => {
            const url = URL.createObjectURL(archivo);
            const globalIndex = imagenesExistentes.length + index;
            html += `
                <div class="image-preview-item" data-index="${globalIndex}" data-new="true">
                    <img src="${url}" alt="Nueva imagen ${index + 1}">
                    <button type="button" class="remove-image-btn" onclick="removerImagenNueva(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    ${globalIndex === 0 ? '<span class="primary-badge">Principal</span>' : ''}
                </div>
            `;
        });
        
        if (imagesGrid) imagesGrid.innerHTML = html;
        
        // Mostrar/ocultar bot√≥n "Subir m√°s"
        if (addMoreBtn) {
            if (totalImagenes < maxImages) {
                addMoreBtn.style.display = 'flex';
            } else {
                addMoreBtn.style.display = 'none';
            }
        }
    }

    // Funci√≥n para cargar datos del producto
    async function cargarProducto() {
        try {
            console.log('üì¶ Cargando producto:', productoId);
            
            const doc = await db.collection('productos').doc(productoId).get();
            
            if (!doc.exists) {
                throw new Error('Producto no encontrado');
            }
            
            productoActual = { id: doc.id, ...doc.data() };
            console.log('‚úÖ Producto cargado:', productoActual);
            
            // Llenar formulario
            document.getElementById('nombre').value = productoActual.nombre || '';
            document.getElementById('descripcion').value = productoActual.descripcion || '';
            document.getElementById('categoria').value = productoActual.categoria || '';
            document.getElementById('unidad').value = productoActual.unidad || '';
            document.getElementById('precio').value = productoActual.precio || '';
            document.getElementById('stock').value = productoActual.stock || '';
            
            // Mostrar im√°genes actuales si existen
            if (productoActual.imagenes && Array.isArray(productoActual.imagenes) && productoActual.imagenes.length > 0) {
                imagenesExistentes = productoActual.imagenes;
            } else if (productoActual.imagen) {
                imagenesExistentes = [productoActual.imagen];
            }
            
            if (imagenesExistentes.length > 0) {
                mostrarVistasPrevia();
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar producto:', error);
            mostrarMensaje('Error al cargar el producto: ' + error.message, 'error');
        }
    }

    // Funci√≥n para remover imagen existente
    window.removerImagenExistente = function(index) {
        console.log('üóëÔ∏è Removiendo imagen existente', index);
        imagenesExistentes.splice(index, 1);
        mostrarVistasPrevia();
    };

    // Funci√≥n para subir imagen
    async function subirImagen(archivo, productoId) {
        try {
            console.log('üì∏ Subiendo imagen...');
            
            if (!storage) {
                console.warn('‚ö†Ô∏è Firebase Storage no est√° inicializado, usando fallback');
                return await subirImagenFallback(archivo, productoId);
            }
            
            const nombreArchivo = `productos/${productoId}/${Date.now()}_${archivo.name}`;
            const storageRef = storage.ref().child(nombreArchivo);
            
            const snapshot = await storageRef.put(archivo);
            const downloadURL = await snapshot.ref.getDownloadURL();
            
            console.log('‚úÖ Imagen subida:', downloadURL);
            return downloadURL;
        } catch (error) {
            console.error('‚ùå Error al subir imagen:', error);
            return await subirImagenFallback(archivo, productoId);
        }
    }

    // Funci√≥n fallback para subir imagen
    async function subirImagenFallback(archivo, productoId) {
        try {
            console.log('üîÑ Usando fallback para imagen...');
            
            const reader = new FileReader();
            const base64Promise = new Promise((resolve, reject) => {
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });
            
            reader.readAsDataURL(archivo);
            const base64Data = await base64Promise;
            
            const imagenData = {
                nombre: archivo.name,
                tipo: archivo.type,
                tama√±o: archivo.size,
                data: base64Data,
                productoId: productoId,
                timestamp: Date.now()
            };
            
            const imagenRef = await db.collection('imagenes_productos').add(imagenData);
            console.log('‚úÖ Imagen guardada en Firestore:', imagenRef.id);
            
            return `firestore://imagenes_productos/${imagenRef.id}`;
        } catch (error) {
            console.error('‚ùå Error en fallback de imagen:', error);
            return null;
        }
    }

    // Funci√≥n para subir m√∫ltiples im√°genes
    async function subirImagenes(archivos, productoId) {
        if (!archivos || archivos.length === 0) {
            return [];
        }
        
        const urls = [];
        for (let i = 0; i < archivos.length; i++) {
            try {
                const url = await subirImagen(archivos[i], productoId);
                if (url) {
                    urls.push(url);
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è Error subiendo imagen ${i + 1}:`, error);
            }
        }
        return urls;
    }
    
    // Funci√≥n para actualizar producto
    async function actualizarProducto(datosProducto, nuevasImagenes = [], imagenesExistentes = []) {
        try {
            if (!currentUser) {
                throw new Error('Usuario no autenticado');
            }

            console.log('üìù Actualizando producto...');

            const producto = {
                nombre: datosProducto.nombre,
                descripcion: datosProducto.descripcion,
                categoria: datosProducto.categoria,
                unidad: datosProducto.unidad,
                precio: parseFloat(datosProducto.precio),
                stock: parseInt(datosProducto.stock),
                vendedor_id: currentUser.uid,
                vendedor_email: currentUser.email,
                vendedor_nombre: currentUser.displayName || currentUser.email,
                fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp(),
                activo: true
            };

            // Combinar im√°genes existentes con las nuevas subidas
            let todasLasImagenes = [...imagenesExistentes];
            
            // Subir nuevas im√°genes si las hay
            if (nuevasImagenes && nuevasImagenes.length > 0) {
                console.log(`üì§ Subiendo ${nuevasImagenes.length} imagen(es) nueva(s)...`);
                const nuevasUrls = await subirImagenes(nuevasImagenes, productoId);
                todasLasImagenes = [...todasLasImagenes, ...nuevasUrls];
            }
            
            // Actualizar campos de im√°genes
            if (todasLasImagenes.length > 0) {
                producto.imagen = todasLasImagenes[0]; // Primera imagen como principal
                producto.imagenes = todasLasImagenes; // Array con todas las im√°genes
            } else {
                producto.imagen = null;
                producto.imagenes = [];
            }

            // Actualizar en Firestore
            await db.collection('productos').doc(productoId).update(producto);
            console.log('‚úÖ Producto actualizado con', todasLasImagenes.length, 'imagen(es)');

            return true;
        } catch (error) {
            console.error('‚ùå Error al actualizar producto:', error);
            throw error;
        }
    }

    // Funci√≥n para remover imagen nueva seleccionada
    window.removerImagenNueva = function(index) {
        console.log('üóëÔ∏è Removiendo imagen nueva', index);
        imagenesSeleccionadas.splice(index, 1);
        mostrarVistasPrevia();
        
        // Actualizar input file
        const imagenInput = document.getElementById('imagen');
        if (imagenInput) {
            const dt = new DataTransfer();
            imagenesSeleccionadas.forEach(archivo => dt.items.add(archivo));
            imagenInput.files = dt.files;
        }
    };
    
    // Configurar manejo de im√°genes m√∫ltiples
    function setupImageHandling() {
        const imagenInput = document.getElementById('imagen');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagesPreviewContainer = document.getElementById('imagesPreviewContainer');
        const imagesGrid = document.getElementById('imagesGrid');
        const removeAllImagesBtn = document.getElementById('removeAllImages');
        const addMoreImagesBtn = document.getElementById('addMoreImagesBtn');
        const maxImages = 5;

        if (imageUploadArea) {
            imageUploadArea.addEventListener('click', () => {
                imagenInput.click();
            });
        }

        if (imagenInput) {
            imagenInput.addEventListener('change', (e) => {
                const archivos = Array.from(e.target.files);
                if (archivos.length === 0) return;
                
                // Validar n√∫mero m√°ximo
                const espaciosDisponibles = maxImages - imagenesExistentes.length - imagenesSeleccionadas.length;
                if (espaciosDisponibles <= 0) {
                    mostrarMensaje(`‚ùå Ya has alcanzado el m√°ximo de ${maxImages} im√°genes`, 'error');
                    return;
                }
                
                // Validar cada archivo
                const archivosValidos = [];
                archivos.forEach((archivo, index) => {
                    if (!archivo.type.startsWith('image/')) {
                        mostrarMensaje(`‚ùå El archivo "${archivo.name}" no es una imagen v√°lida`, 'error');
                        return;
                    }
                    
                    if (archivo.size > 5 * 1024 * 1024) {
                        mostrarMensaje(`‚ùå La imagen "${archivo.name}" es demasiado grande. M√°ximo 5MB`, 'error');
                        return;
                    }
                    
                    archivosValidos.push(archivo);
                });
                
                // Agregar solo las que quepan
                const imagenesAAgregar = archivosValidos.slice(0, espaciosDisponibles);
                imagenesSeleccionadas = [...imagenesSeleccionadas, ...imagenesAAgregar];
                
                if (archivosValidos.length > espaciosDisponibles) {
                    mostrarMensaje(`‚ö†Ô∏è Solo se agregaron ${espaciosDisponibles} imagen(es). Ya tienes ${maxImages} im√°genes en total.`, 'error');
                }
                
                mostrarVistasPrevia();
            });
        }
        
        // Bot√≥n para remover todas las im√°genes
        if (removeAllImagesBtn) {
            removeAllImagesBtn.addEventListener('click', () => {
                if (confirm('¬øEst√°s seguro de que quieres eliminar todas las im√°genes?')) {
                    imagenesExistentes = [];
                    imagenesSeleccionadas = [];
                    if (imagenInput) imagenInput.value = '';
                    mostrarVistasPrevia();
                }
            });
        }
        
        // Bot√≥n para agregar m√°s im√°genes
        if (addMoreImagesBtn) {
            addMoreImagesBtn.addEventListener('click', () => {
                imagenInput.click();
            });
        }
    }

    // Manejar formulario
    document.addEventListener('DOMContentLoaded', function() {
        setupImageHandling();
        
        const form = document.getElementById('productForm');
        
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = form.querySelector('.submit-btn');
                
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
                }

                try {
                    const formData = new FormData(form);
                    const datosProducto = {
                        nombre: formData.get('nombre'),
                        descripcion: formData.get('descripcion'),
                        categoria: formData.get('categoria'),
                        unidad: formData.get('unidad'),
                        precio: parseFloat(formData.get('precio')),
                        stock: parseInt(formData.get('stock'))
                    };

                    console.log('üìã Formulario enviado');

                    if (!datosProducto.nombre || !datosProducto.descripcion || !datosProducto.categoria) {
                        throw new Error('Por favor completa todos los campos obligatorios');
                    }

                    await actualizarProducto(datosProducto, imagenesSeleccionadas, imagenesExistentes);
                    
                    // Redirigir inmediatamente con par√°metro de √©xito
                    window.location.href = '/vendedor/mis_productos?updated=success';

                } catch (error) {
                    console.error('‚ùå Error:', error);
                    mostrarMensaje('‚ùå Error: ' + error.message, 'error');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Producto';
                    }
                }
            });
        }
    });

    // Inicializar Firebase y cargar producto
    inicializarFirebase().then(() => {
        console.log('üî• Firebase inicializado correctamente');
        
        // Verificar autenticaci√≥n
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ Usuario autenticado:', user.email);
                
                const saludoElement = document.querySelector('.saludo-usuario strong');
                if (saludoElement) {
                    saludoElement.textContent = user.displayName || user.email;
                }
                
                cargarProducto();
            } else {
                console.log('‚ùå Usuario no autenticado');
                window.location.href = '/auth/login';
            }
        });
        
    }).catch((error) => {
        console.error('‚ùå Error inicializando Firebase:', error);
        mostrarMensaje('‚ùå Error de conexi√≥n. Recarga la p√°gina.', 'error');
    });

    // Funci√≥n para cancelar edici√≥n
    function cancelarEdicion() {
        // Verificar si hay cambios sin guardar
        const form = document.getElementById('productForm');
        const formData = new FormData(form);
        
        // Comparar con datos originales
        let hayCambios = false;
        
        if (productoActual) {
            if (formData.get('nombre') !== productoActual.nombre ||
                formData.get('descripcion') !== productoActual.descripcion ||
                formData.get('categoria') !== productoActual.categoria ||
                formData.get('unidad') !== productoActual.unidad ||
                parseFloat(formData.get('precio')) !== productoActual.precio ||
                parseInt(formData.get('stock')) !== productoActual.stock ||
                imagenesSeleccionadas.length > 0 ||
                imagenesExistentes.length !== (productoActual.imagenes ? productoActual.imagenes.length : (productoActual.imagen ? 1 : 0))) {
                hayCambios = true;
            }
        }
        
        if (hayCambios) {
            // Mostrar confirmaci√≥n si hay cambios
            if (confirm('¬øEst√°s seguro de que quieres cancelar? Se perder√°n los cambios no guardados.')) {
                window.location.href = '/vendedor/mis_productos';
            }
        } else {
            // No hay cambios, cancelar directamente
            window.location.href = '/vendedor/mis_productos';
        }
    }

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
        if (auth) {
            auth.signOut().then(() => {
                window.location.href = '/auth/login';
            }).catch((error) => {
                console.error('Error al cerrar sesi√≥n:', error);
            });
        } else {
            window.location.href = '/auth/login';
        }
    }
    </script>
</body>
</html>