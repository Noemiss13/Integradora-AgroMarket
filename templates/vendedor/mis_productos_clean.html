<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Productos - AgroMarket</title>
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/estilos_vendedor.css">
    <link rel="stylesheet" href="/static/css/mis_productos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<nav>
    <div class="nav-left">
        <div class="logo"><h2>AgroMarket</h2></div>
        <div class="saludo-usuario">Hola, <strong>{{ nombre }}</strong></div>
    </div>
    <div class="menu">
        <a href="/vendedor/panel">Home</a>
        <a href="/vendedor/agregar_producto">Agregar Productos</a>
        <a href="/vendedor/mis_productos" class="activo">Mis Productos</a>
        <a href="#" onclick="alert('Funci√≥n pr√≥ximamente')">Ventas</a>
        <a href="#" onclick="alert('Funci√≥n pr√≥ximamente')">Mi Perfil</a>
        <a href="#" onclick="cerrarSesion()">Cerrar Sesi√≥n</a>
    </div>
</nav>

<main>
    <div class="container">
        <div class="header">
            <h1>Mis productos</h1>
            <p>Administre su inventario: edite, pause o elimine productos.</p>
        </div>
        
        <div class="filters-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por nombre..." class="search-input">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn" id="categoryFilter">Categor√≠a</button>
                <button class="filter-btn" id="statusFilter">Estado</button>
                <button class="add-btn" onclick="window.location.href='/vendedor/agregar_producto'">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>
        </div>
        
        <div class="products-table-container">
            <div class="table-header">
                <div class="table-cell">Producto</div>
                <div class="table-cell">Categor√≠a</div>
                <div class="table-cell">Precio</div>
                <div class="table-cell">Stock</div>
                <div class="table-cell">Unidad</div>
                <div class="table-cell">Acciones</div>
            </div>
            
            <div id="productsContainer" class="table-body">
                <p>Cargando productos...</p>
            </div>
        </div>
        
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination-info">
                <span id="paginationInfo">Mostrando 1-3 de 24 productos</span>
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" id="prevBtn">Anterior</button>
                <button class="pagination-btn" id="nextBtn">Siguiente</button>
            </div>
        </div>
        
        <div class="status-box" id="statusBox" style="display: none;">
            <strong>Estado del Sistema:</strong><br>
            <span id="statusText">Iniciando...</span>
        </div>
    </div>
</main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Firebase Config -->
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBvQZvQZvQZvQZvQZvQZvQZvQZvQZvQZvQ",
        authDomain: "agromarket-12345.firebaseapp.com",
        projectId: "agromarket-12345",
        storageBucket: "agromarket-12345.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:abcdef1234567890abcdef"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Configurar Firestore
    db.settings({
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
        ignoreUndefinedProperties: true
    });

    // Configurar Auth
    auth.useDeviceLanguage();
</script>

<!-- Firebase Auth Integration -->
<script src="/static/js/firebase-auth-integration.js"></script>

<script>
    // Funci√≥n para actualizar el estado del sistema
    function updateStatus(message) {
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        
        if (statusBox && statusText) {
            statusText.innerHTML = message;
            statusBox.style.display = 'block';
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                statusBox.style.display = 'none';
            }, 3000);
        }
    }

    // Funci√≥n para mostrar mensaje de error
    function showError(message) {
        alert('Error: ' + message);
    }

    // Funci√≥n para mostrar mensaje de √©xito
    function showSuccess(message) {
        alert('√âxito: ' + message);
    }

    // Funci√≥n para mostrar mensaje
    function mostrarMensaje(mensaje, tipo = 'info') {
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        
        if (statusBox && statusText) {
            statusText.innerHTML = mensaje;
            statusBox.style.display = 'block';
            
            // Cambiar color seg√∫n el tipo
            if (tipo === 'error') {
                statusBox.style.background = '#f8d7da';
                statusBox.style.borderColor = '#f5c6cb';
                statusBox.style.color = '#721c24';
            } else if (tipo === 'success') {
                statusBox.style.background = '#d4edda';
                statusBox.style.borderColor = '#c3e6cb';
                statusBox.style.color = '#155724';
            } else {
                statusBox.style.background = '#e7f3ff';
                statusBox.style.borderColor = '#b3d9ff';
                statusBox.style.color = '#0c5460';
            }
            
            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                statusBox.style.display = 'none';
            }, 3000);
        }
    }

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
        auth.signOut().then(() => {
            window.location.href = '/';
        }).catch((error) => {
            updateStatus('Error al cerrar sesi√≥n: ' + error.message);
        });
    }

    // Verificar autenticaci√≥n
    auth.onAuthStateChanged((user) => {
        if (user) {
            updateStatus('‚úÖ Usuario autenticado: ' + user.email);
            updateStatus('üÜî User ID: ' + user.uid);
            
            // Actualizar nombre en la p√°gina
            const saludoElement = document.querySelector('.saludo-usuario strong');
            if (saludoElement) {
                saludoElement.textContent = user.displayName || user.email;
            }
            
            // Cargar productos
            loadProducts(user.uid);
        } else {
            updateStatus('‚ùå Usuario no autenticado');
            updateStatus('üîÑ Redirigiendo al login...');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        }
    });

    // Funci√≥n para cargar productos
    async function loadProducts(vendedorId) {
        try {
            updateStatus('üì¶ Cargando productos para vendedor: ' + vendedorId);
            
            // Intentar diferentes campos de vendedor
            let productosRef = db.collection('productos').where('vendedor_id', '==', vendedorId);
            let snapshot = await productosRef.get();
            
            // Si no encuentra productos con vendedor_id, intentar con vendedorId
            if (snapshot.empty) {
                productosRef = db.collection('productos').where('vendedorId', '==', vendedorId);
                snapshot = await productosRef.get();
            }
            
            // Si a√∫n no encuentra productos, intentar con uid
            if (snapshot.empty) {
                productosRef = db.collection('productos').where('uid', '==', vendedorId);
                snapshot = await productosRef.get();
            }
            
            // Si a√∫n no encuentra productos, cargar todos y filtrar
            if (snapshot.empty) {
                productosRef = db.collection('productos');
                snapshot = await productosRef.get();
            }
            
            if (snapshot.empty) {
                updateStatus('üì≠ No se encontraron productos');
                showNoProducts();
                return;
            }
            
            const productos = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // Filtrar por vendedor si es necesario
                if (data.vendedor_id === vendedorId || 
                    data.vendedorId === vendedorId || 
                    data.uid === vendedorId ||
                    snapshot.size <= 10) { // Si hay pocos productos, mostrar todos
                    productos.push({
                        id: doc.id,
                        ...data
                    });
                }
            });
            
            updateStatus('‚úÖ Productos encontrados: ' + productos.length);
            showProducts(productos);
            
        } catch (error) {
            updateStatus('‚ùå Error al cargar productos: ' + error.message);
            showError('Error al cargar productos: ' + error.message);
        }
    }

    // Funci√≥n para mostrar productos
    async function showProducts(productos) {
        const container = document.getElementById('productsContainer');
        
        if (productos.length === 0) {
            showNoProducts();
            return;
        }
        
        // Procesar cada producto para obtener su imagen
        const productosConImagenes = await Promise.all(productos.map(async (producto) => {
            let imagenUrl = producto.imagen_url || null;
            
            if (imagenUrl && imagenUrl.startsWith('firestore://imagenes_productos/')) {
                try {
                    imagenUrl = await obtenerImagenDesdeFirestore(imagenUrl);
                } catch (error) {
                    console.warn('Error al obtener imagen:', error);
                    imagenUrl = null;
                }
            }
            
            return { ...producto, imagenUrl };
        }));
        
        const html = productosConImagenes.map(producto => {
            // Asegurar que todos los campos tengan valores por defecto
            const productoCompleto = {
                id: producto.id || '',
                nombre: producto.nombre || 'Sin nombre',
                descripcion: producto.descripcion || 'Sin descripci√≥n',
                categoria: producto.categoria || 'Sin categor√≠a',
                precio: parseFloat(producto.precio) || 0,
                stock: parseInt(producto.stock) || 0,
                unidad: 'kg', // Forzar que siempre sea kg
                activo: true, // Forzar que siempre sea activo por defecto
                imagenUrl: producto.imagenUrl || null
            };
            
            return `
                <div class="product-row">
                    <div class="product-cell">
                        <div class="product-info">
                            ${productoCompleto.imagenUrl ? 
                                `<img src="${productoCompleto.imagenUrl}" alt="${productoCompleto.nombre}" class="product-image">` : 
                                `<div class="product-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image" style="color: #999;"></i>
                                </div>`
                            }
                            <div class="product-details">
                                <h4>${productoCompleto.nombre}</h4>
                                <p>${productoCompleto.descripcion.length > 30 ? productoCompleto.descripcion.substring(0, 30) + '...' : productoCompleto.descripcion}</p>
                            </div>
                        </div>
                    </div>
                    <div class="product-cell">${productoCompleto.categoria}</div>
                    <div class="product-cell">$${productoCompleto.precio.toFixed(2)}</div>
                    <div class="product-cell">${productoCompleto.stock}</div>
                    <div class="product-cell">${productoCompleto.unidad}</div>
                    <div class="product-cell">
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editProduct('${productoCompleto.id}')">
                                Editar
                            </button>
                            <button class="action-btn pause" onclick="pauseProduct('${productoCompleto.id}')">
                                Pausar
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${productoCompleto.id}', '${productoCompleto.nombre}')">
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
        
        // Mostrar paginaci√≥n si hay productos
        if (productos.length > 0) {
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (paginationContainer && paginationInfo) {
                paginationInfo.textContent = `Mostrando 1-${productos.length} de ${productos.length} productos`;
                paginationContainer.style.display = 'flex';
            }
        }
    }

    // Funci√≥n para mostrar mensaje cuando no hay productos
    function showNoProducts() {
        const container = document.getElementById('productsContainer');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                <h3>No hay productos</h3>
                <p>Comienza agregando tu primer producto.</p>
                <button class="add-btn" onclick="window.location.href='/vendedor/agregar_producto'" style="margin-top: 16px;">
                    <i class="fas fa-plus"></i> Agregar Producto
                </button>
            </div>
        `;
    }

    // Funci√≥n para obtener imagen desde Firestore
    async function obtenerImagenDesdeFirestore(imagenUrl) {
        try {
            const docRef = db.collection('imagenes_productos').doc(imagenUrl.replace('firestore://imagenes_productos/', ''));
            const doc = await docRef.get();
            
            if (doc.exists) {
                const data = doc.data();
                return `data:${data.tipo || 'image/jpeg'};base64,${data.datos}`;
            } else {
                console.warn('Documento de imagen no encontrado:', imagenUrl);
                return null;
            }
        } catch (error) {
            console.error('Error al obtener imagen desde Firestore:', error);
            return null;
        }
    }

    // Funci√≥n para editar producto
    function editProduct(productId) {
        window.location.href = `/vendedor/editar/${productId}`;
    }

    // Funci√≥n para pausar producto
    async function pauseProduct(productId) {
        if (!confirm('¬øEst√°s seguro de que quieres pausar este producto?')) {
            return;
        }
        
        try {
            updateStatus('‚è∏Ô∏è Pausando producto...');
            await db.collection('productos').doc(productId).update({
                activo: false,
                fecha_actualizacion: firebase.firestore.FieldValue.serverTimestamp()
            });
            updateStatus('‚úÖ Producto pausado exitosamente');
            
            // Recargar productos
            const user = auth.currentUser;
            if (user) {
                loadProducts(user.uid);
            }
            
        } catch (error) {
            updateStatus('‚ùå Error al pausar producto: ' + error.message);
            alert('Error al pausar el producto: ' + error.message);
        }
    }

    // Funci√≥n para eliminar producto
    async function deleteProduct(productId, productName) {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar el producto "' + productName + '"?')) {
            return;
        }
        
        try {
            updateStatus('üóëÔ∏è Eliminando producto...');
            await db.collection('productos').doc(productId).delete();
            updateStatus('‚úÖ Producto eliminado exitosamente');
            
            // Recargar productos
            const user = auth.currentUser;
            if (user) {
                loadProducts(user.uid);
            }
            
        } catch (error) {
            updateStatus('‚ùå Error al eliminar producto: ' + error.message);
            alert('Error al eliminar el producto: ' + error.message);
        }
    }
</script>
</body>
</html>
