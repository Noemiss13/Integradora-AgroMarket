<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Carrito - AgroMarket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .carrito-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ›’ Test de Funcionalidad del Carrito</h1>
        
        <div class="test-section">
            <h3>ðŸ”§ Estado de Firebase</h3>
            <div id="firebase-status" class="status info">Verificando conexiÃ³n...</div>
            <button onclick="verificarFirebase()">Verificar Firebase</button>
        </div>
        
        <div class="test-section">
            <h3>ðŸ‘¤ Estado de AutenticaciÃ³n</h3>
            <div id="auth-status" class="status info">Verificando autenticaciÃ³n...</div>
            <button onclick="verificarAuth()">Verificar Auth</button>
            <button onclick="loginTest()">Login Test</button>
            <button onclick="logoutTest()">Logout Test</button>
        </div>
        
        <div class="test-section">
            <h3>ðŸ“¦ Productos Disponibles</h3>
            <div id="productos-status" class="status info">Cargando productos...</div>
            <button onclick="cargarProductos()">Cargar Productos</button>
            <div id="productos-lista"></div>
        </div>
        
        <div class="test-section">
            <h3>ðŸ›’ Carrito</h3>
            <div id="carrito-status" class="status info">Verificando carrito...</div>
            <button onclick="verCarrito()">Ver Carrito</button>
            <button onclick="limpiarCarrito()">Limpiar Carrito</button>
            <div id="carrito-lista"></div>
        </div>
        
        <div class="test-section">
            <h3>ðŸ§ª Test de Agregar al Carrito</h3>
            <div id="test-status" class="status info">Listo para probar</div>
            <button onclick="testAgregarCarrito()">Test Agregar al Carrito</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- Firebase Config -->
    <script src="/static/js/firebase-config.js"></script>
    
    <script>
        let db;
        let productos = [];
        
        // Inicializar Firebase
        async function inicializarFirebase() {
            try {
                console.log('ðŸ”„ Inicializando Firebase...');
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no estÃ¡ cargado');
                }
                
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(window.firebaseConfig);
                }
                
                db = firebase.firestore();
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true
                });
                
                console.log('âœ… Firebase inicializado');
                return true;
            } catch (error) {
                console.error('âŒ Error inicializando Firebase:', error);
                return false;
            }
        }
        
        // Verificar Firebase
        async function verificarFirebase() {
            const status = document.getElementById('firebase-status');
            try {
                const inicializado = await inicializarFirebase();
                if (inicializado) {
                    status.className = 'status success';
                    status.textContent = 'âœ… Firebase conectado correctamente';
                } else {
                    status.className = 'status error';
                    status.textContent = 'âŒ Error conectando Firebase';
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error: ' + error.message;
            }
        }
        
        // Verificar autenticaciÃ³n
        function verificarAuth() {
            const status = document.getElementById('auth-status');
            const user = firebase.auth().currentUser;
            
            if (user) {
                status.className = 'status success';
                status.textContent = `âœ… Usuario autenticado: ${user.email}`;
            } else {
                status.className = 'status error';
                status.textContent = 'âŒ Usuario no autenticado';
            }
        }
        
        // Login de prueba
        async function loginTest() {
            const status = document.getElementById('auth-status');
            try {
                // Usar email de prueba (necesitarÃ¡s crear este usuario en Firebase Auth)
                const email = 'test@agromarket.com';
                const password = 'test123';
                
                await firebase.auth().signInWithEmailAndPassword(email, password);
                status.className = 'status success';
                status.textContent = `âœ… Login exitoso: ${email}`;
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error en login: ' + error.message;
            }
        }
        
        // Logout de prueba
        async function logoutTest() {
            const status = document.getElementById('auth-status');
            try {
                await firebase.auth().signOut();
                status.className = 'status info';
                status.textContent = 'â„¹ï¸ Usuario deslogueado';
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error en logout: ' + error.message;
            }
        }
        
        // Cargar productos
        async function cargarProductos() {
            const status = document.getElementById('productos-status');
            const lista = document.getElementById('productos-lista');
            
            try {
                if (!db) {
                    throw new Error('Firebase no inicializado');
                }
                
                const snapshot = await db.collection('productos').get();
                productos = [];
                
                snapshot.forEach(doc => {
                    productos.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                status.className = 'status success';
                status.textContent = `âœ… ${productos.length} productos cargados`;
                
                // Mostrar productos
                lista.innerHTML = productos.map(producto => `
                    <div class="carrito-item">
                        <strong>${producto.nombre}</strong> - $${producto.precio} 
                        <button onclick="agregarProductoTest('${producto.id}')">Agregar</button>
                    </div>
                `).join('');
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error cargando productos: ' + error.message;
            }
        }
        
        // Ver carrito
        async function verCarrito() {
            const status = document.getElementById('carrito-status');
            const lista = document.getElementById('carrito-lista');
            
            try {
                if (!db) {
                    throw new Error('Firebase no inicializado');
                }
                
                const user = firebase.auth().currentUser;
                if (!user) {
                    status.className = 'status error';
                    status.textContent = 'âŒ Usuario no autenticado';
                    return;
                }
                
                const snapshot = await db.collection('carrito')
                    .where('usuario_id', '==', user.uid)
                    .get();
                
                const items = [];
                snapshot.forEach(doc => {
                    items.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                status.className = 'status success';
                status.textContent = `âœ… ${items.length} items en el carrito`;
                
                // Mostrar items del carrito
                lista.innerHTML = items.map(item => `
                    <div class="carrito-item">
                        <strong>${item.nombre}</strong> - Cantidad: ${item.cantidad} - $${item.precio}
                        <button onclick="eliminarItem('${item.id}')">Eliminar</button>
                    </div>
                `).join('');
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error viendo carrito: ' + error.message;
            }
        }
        
        // Limpiar carrito
        async function limpiarCarrito() {
            const status = document.getElementById('carrito-status');
            
            try {
                if (!db) {
                    throw new Error('Firebase no inicializado');
                }
                
                const user = firebase.auth().currentUser;
                if (!user) {
                    status.className = 'status error';
                    status.textContent = 'âŒ Usuario no autenticado';
                    return;
                }
                
                const snapshot = await db.collection('carrito')
                    .where('usuario_id', '==', user.uid)
                    .get();
                
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                status.className = 'status success';
                status.textContent = 'âœ… Carrito limpiado';
                document.getElementById('carrito-lista').innerHTML = '';
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error limpiando carrito: ' + error.message;
            }
        }
        
        // Agregar producto de prueba
        async function agregarProductoTest(productoId) {
            const status = document.getElementById('test-status');
            
            try {
                const producto = productos.find(p => p.id === productoId);
                if (!producto) {
                    throw new Error('Producto no encontrado');
                }
                
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado');
                }
                
                const itemCarrito = {
                    producto_id: productoId,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    cantidad: 1,
                    unidad: producto.unidad || 'kg',
                    imagen: producto.imagen,
                    vendedor_nombre: producto.vendedor_nombre || 'Test',
                    fecha_agregado: new Date().toISOString(),
                    usuario_id: user.uid
                };
                
                await db.collection('carrito').add(itemCarrito);
                
                status.className = 'status success';
                status.textContent = `âœ… ${producto.nombre} agregado al carrito`;
                
                mostrarNotificacion(`âœ… ${producto.nombre} agregado al carrito`);
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Error: ' + error.message;
            }
        }
        
        // Test completo
        async function testAgregarCarrito() {
            const status = document.getElementById('test-status');
            status.className = 'status info';
            status.textContent = 'ðŸ§ª Ejecutando test completo...';
            
            try {
                // 1. Verificar Firebase
                if (!db) {
                    await inicializarFirebase();
                }
                
                // 2. Verificar autenticaciÃ³n
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado. Haz login primero.');
                }
                
                // 3. Cargar productos si no estÃ¡n cargados
                if (productos.length === 0) {
                    await cargarProductos();
                }
                
                // 4. Agregar primer producto
                if (productos.length > 0) {
                    await agregarProductoTest(productos[0].id);
                } else {
                    throw new Error('No hay productos disponibles');
                }
                
                status.className = 'status success';
                status.textContent = 'âœ… Test completo exitoso';
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ Test fallÃ³: ' + error.message;
            }
        }
        
        // Eliminar item del carrito
        async function eliminarItem(itemId) {
            try {
                await db.collection('carrito').doc(itemId).delete();
                mostrarNotificacion('âœ… Item eliminado del carrito');
                verCarrito(); // Actualizar vista
            } catch (error) {
                console.error('Error eliminando item:', error);
            }
        }
        
        // Mostrar notificaciÃ³n
        function mostrarNotificacion(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.remove();
            }, 3000);
        }
        
        // Inicializar cuando carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Iniciando test de carrito...');
            await verificarFirebase();
            verificarAuth();
        });
    </script>
</body>
</html>
